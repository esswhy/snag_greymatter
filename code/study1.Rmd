---
title: 'Study 1: Hormones and Behavior'
author: "Shuying Yu"
date: "7/22/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      include = FALSE, fig.align = "center")

#Attach libraries
library(tidyverse)
library(here)
library(janitor)
library(ggpubr)
library(patchwork)
library(kableExtra)
library(foreign)
library(RColorBrewer)
library(plotly)
library(readr)
library(DescTools)
library(outliers)
library(ggbeeswarm)
```


*Modified on:* February 8th, 2022

# Introduction


Study 1 aims to investigate the relationship between sex hormones and spatial navigation behavior in midlife women and men.

# Research Question

Do sex hormones (estradiol, progesterone, FSH) covary with dependent variables in each spatial navigation task (LOOP, MAZE, DSP) for midlife women and men?

**Prediction:** The decline in ovarian estradiol production in midlife women will be associated with a shift in performance characteristics across spatial navigation paradigms, including more position errors in the LOOP task, fewer correct targets in the MAZE task, and an increased reliance on response-based strategies in the DSP task. For men, I hypothesize that lower testosterone concentrations will also be associated with more position errors in the LOOP task, fewer correct targets in the MAZE task, and an increased reliance on response-based strategies in the DSP task. 

Does the ratio of E/FSH among midlife women covary with position error in LOOP, accuracy in MAZE, or navigation strategy in DSP?

**Prediction:** Women with higher ratio of FSH to E (estradiol) will have more position errors in LOOP, less accuracy in MAZE, and more likely to use response-based strategies in DSP compared to women with higher E to FSH.

Another (future) aim is to characterize the change in spatial navigation behavior for men and women from young to midlife. Using data collection from young adults (SNAG, OHS, HAS),I will plot how changes in behavior change with age for mainly women and men.

# Methods

## Participants

Midlife Adults

```{r include=TRUE, echo=FALSE}
#Table for final sample and age mean, sd for Aim 1
df_all <- read_csv(here("data", "HAS_SNAG_mastersheet_tidy.csv"))

#Filter for those with SNAG data
aim1 <- df_all %>% filter(completed_spatial == "Yes",
                          age_group == "Midlife") %>% 
   #Further exclude these subjects:
  filter(!subject_id %in% c(
    #"309", #bad participant
    #"316", #vertigo/took Wellbutrin for mood and Lipitor for cholesterol 7 days/week of scan
     "329", #on prednisone 7 days/week of scan
    #"352", #current MDD/depression
     "372" #past neuroschistosomiasis at 24 years old
  ))

#Filter for men
aim1_men <- aim1 %>% 
  filter(sex == "Male")
#Filter for women
aim1_women <- aim1 %>% 
  filter(sex == "Female") %>% 
  #Reorder repo status
  mutate(repo_status = fct_relevel(repo_status, 
                                  c("Pre", "Peri", "Post")))

#Table overall
tab_overall <- aim1 %>% 
  group_by(sex) %>% 
  summarize(n_subject = n(),
            age_mean = mean(age_spatial_years),
            age_Sd = sd(age_spatial_years))

#Table LOOP
tab_loop <- aim1 %>% 
  filter(loop_useable == "Yes") %>% 
  group_by(sex) %>% 
  summarize(n_subject = n(),
            age_mean = mean(age_spatial_years),
            age_Sd = sd(age_spatial_years))

#Table MAZE
tab_maze <- aim1 %>% 
  filter(maze_useable == "Yes") %>% 
  group_by(sex) %>% 
  summarize(n_subject = n(),
            age_mean = mean(age_spatial_years),
            age_Sd = sd(age_spatial_years))


#Table DSP
tab_dsp <- aim1 %>% 
  filter(dsp_useable == "Yes") %>% 
  group_by(sex) %>% 
  summarize(n_subject = n(),
            age_mean = mean(age_spatial_years),
            age_Sd = sd(age_spatial_years))


#Join df based on sex
tab1 <- merge(tab_overall, tab_loop, by = "sex")

#Rename columns
tab1 <- tab1 %>% 
  rename(n_subject_overall = n_subject.x,
         age_mean_overall = age_mean.x,
         age_sd_overall = age_Sd.x,
         n_subject_loop = n_subject.y,
         age_mean_loop = age_mean.y,
         age_sd_loop = age_Sd.y)

#Rest of the merge
tab2 <- merge(tab1, tab_maze, by = "sex")
tab_final <- merge(tab2, tab_dsp, by = "sex")


#Rename columns
tab_final <- tab_final %>% 
  rename(n_subject_maze = n_subject.x,
         age_mean_maze = age_mean.x,
         age_sd_maze = age_Sd.x,
         n_subject_dsp = n_subject.y,
         age_mean_dsp = age_mean.y,
         age_sd_dsp = age_Sd.y)

#Kable presentation (ideal if we had all hormones)
tab_final %>% 
  kable(col.names = c("Sex", "n","Mean Age","SD Age",
                      "n","Mean Age","SD Age",
                      "n","Mean Age","SD Age",
                      "n","Mean Age","SD Age"),
        caption = "Sample size and age for women and men grouped by overall completion of spatial navigation behavior.") %>% 
  kable_styling("striped", full_width = FALSE,
                position = "center", 
                font_size = 12) %>%
  add_header_above(c(" " = 1, "Overall" = 3, 
                     "LOOP" = 3, "MAZE" = 3, "DSP" = 3))
```

**WOMEN**

Some women only had a few hormones available for analysis:

- 335: only have E, did LOOP

- 336: only have E, did MAZE

- 338: only have E, did LOOP and MAZE

- 344: only have E, did LOOP and MAZE

- 349: only have E, did LOOP

- 367: only have E & T, did LOOP and DSP

- 371: only have E & T, did only LOOP


Thus for women, sample sizes in the following correlation analyses are 

- Estradiol: *n* = 32 for LOOP, *n* = 64 for MAZE, and *n* = 47 for DSP.

- Progesterone: *n* = 26 for LOOP, *n* = 61 for MAZE, and *n* = 46 for DSP.

- FSH: *n* = 26 for LOOP, *n* = 61 for MAZE, and *n* = 46 for DSP.


**MEN**

- 365: only have SHBG, did LOOP and DSP

Thus for men, sample sizes in the following correlation analyses are *n* = 21 for LOOP, *n* = 23 for MAZE, and *n* = 28 for DSP.


## Task Paradigms

Same as those reported in *Yu et al. (2021)*. Hormones are testosterone for men; and estradiol, progesterone, FSH for women. Hormones are taken during time of spatial navigation task.

```{r dsp-pe-plot}
#Grid vs weighted general
par(mfrow = c(1,2))
hist(aim1$dsp_path_efficiency_grid, main = "Grid", xlab = "Path Efficiency")
hist(aim1$dsp_path_efficiency_grid_weighted, main = "Weighted", xlab = "Path Efficiency")
t.test(aim1$dsp_path_efficiency_grid, aim1$dsp_path_efficiency_grid_weighted) #no

#separated by men
t.test(aim1_men$dsp_path_efficiency_grid, aim1_men$dsp_path_efficiency_grid_weighted) #no

#women
t.test(aim1_women$dsp_path_efficiency_grid, aim1_women$dsp_path_efficiency_grid_weighted) #no
```


Difference between DSP path efficiency using grid distance and grid distance weighted are not statistically different, so use the weighted version.

For now, MAZE path efficiency scores have been updated but are not yet finalized (January 17th, 2022).


# Results


## Men: Hormone and Behavior Correlations


```{r normality-check-men, echo=FALSE, results='hide'}
shapiro.test(aim1_men$loop_pe_rad3_m) #no
shapiro.test(aim1_men$loop_de_rad3_degree) #yes
shapiro.test(aim1_men$loop_de_avg_degree) #no
shapiro.test(aim1_men$loop_ae_rad3_degree) #no
shapiro.test(aim1_men$loop_ae_avg_degree) #no

shapiro.test(aim1_men$maze_accuracy_pct) #yes
shapiro.test(aim1_men$maze_moves) #no
shapiro.test(aim1_men$maze_path_efficiency) #no

shapiro.test(aim1_men$dsp_si_true_pct) #yes
shapiro.test(aim1_men$dsp_success_pct) #no
shapiro.test(aim1_men$dsp_path_efficiency_grid_weighted) #no

shapiro.test(aim1_men$testosterone_spatial_ng_dl) #no
```


Spearman rank correlations were used for LOOP degrees at radius 3.0m, MAZE accuracy, DSP solution index. All other correlations for men were Pearson.
 
 
### LOOP

```{r}
#Filter for men with loop and testosterone
aim1_men_loop <- aim1_men %>% 
  dplyr::select(subject_id, loop_useable, 
                loop_pe_rad3_m, 
                loop_de_rad3_degree, loop_de_avg_degree,
                loop_ae_rad3_degree, loop_ae_avg_degree,
                testosterone_spatial_ng_dl) %>% 
  filter(loop_useable == "Yes")
         #is.na(testosterone_spatial_ng_dl) != TRUE)
#n=22, otherwise n=21 for no T

aim1_men_loop %>% #group_by(repo_status) %>% 
  summarize(count = n(),
            mean_pe3 = mean(loop_pe_rad3_m, na.rm=T),
            sd_pe3 = sd(loop_pe_rad3_m, na.rm=T),
            mean_de3 = mean(loop_de_rad3_degree, na.rm=T),
            sd_de3 = sd(loop_de_rad3_degree, na.rm=T),
            mean_de_avg = mean(loop_de_avg_degree),
            sd_de_avg = sd(loop_de_avg_degree),
            mean_ae3 = mean(loop_ae_rad3_degree, na.rm=T),
            sd_ae3 = sd(loop_ae_rad3_degree, na.rm=T),
            mean_ae_avg = mean(loop_ae_avg_degree),
            sd_ae_avg = sd(loop_ae_avg_degree))


#Normality test
shapiro.test(aim1_men_loop$loop_pe_rad3_m) #no
shapiro.test(aim1_men_loop$loop_de_rad3_degree) #yes
shapiro.test(aim1_men_loop$loop_de_avg_degree) #no
shapiro.test(aim1_men_loop$loop_ae_rad3_degree) #no
shapiro.test(aim1_men_loop$loop_ae_avg_degree) #no
shapiro.test(aim1_men_loop$testosterone_spatial_ng_dl) #no


######## Outlier test for degrees 3.0m ########
test <- grubbs.test(aim1_men_loop$loop_de_rad3_degree)
test #highest value is an outlier (p-value = 0.001135)

test <- grubbs.test(men_loop_no354$loop_de_rad3_degree)
test #next highest is also outlier p-value = 0.006373

#What if we remove subject 354
men_loop_no354 <- aim1_men_loop %>% filter(!subject_id %in% c(354))
men_loop_both <- aim1_men_loop %>% filter(!subject_id %in% c(354, 320))
shapiro.test(men_loop_no354$loop_de_rad3_degree) #no
#Corr
cor.test(men_loop_no354$testosterone_spatial_ng_dl,
         men_loop_no354$loop_de_rad3_degree,
         conf.level = 0.95,
         method = "pearson") #NOT SIG, p =0.13
cor.test(men_loop_both$testosterone_spatial_ng_dl,
         men_loop_both$loop_de_rad3_degree,
         conf.level = 0.95,
         method = "pearson") #NOT SIG, p =0.156



########## Pearson for position error 3.0m
cor.test(aim1_men_loop$testosterone_spatial_ng_dl,
         aim1_men_loop$loop_pe_rad3_m,
         conf.level = 0.95,
         method = "pearson")

########## Spearman for degrees traveled 3.0m
cor.test(aim1_men_loop$testosterone_spatial_ng_dl,
         aim1_men_loop$loop_de_rad3_degree,
         conf.level = 0.95,
         method = "spearman")

########## Pearson for degrees traveled avg
cor.test(aim1_men_loop$testosterone_spatial_ng_dl,
         aim1_men_loop$loop_de_avg_degree,
         conf.level = 0.95,
         method = "pearson")

########## Pearson for angular error 3.0m
cor.test(aim1_men_loop$testosterone_spatial_ng_dl,
         aim1_men_loop$loop_de_avg_degree,
         conf.level = 0.95,
         method = "pearson")

########## Pearson for angular error avg
cor.test(aim1_men_loop$testosterone_spatial_ng_dl,
         aim1_men_loop$loop_de_avg_degree,
         conf.level = 0.95,
         method = "pearson")
```

```{r loop-men-de}
#Get CI for rho
DescTools::SpearmanRho(aim1_men_loop$testosterone_spatial_ng_dl,
                       aim1_men_loop$loop_de_rad3_degree,
                       use = "complete.obs",
                       conf.level	= 0.95)
```


Degrees traveled at 3.0m was negatively correlated with testosterone ($\rho$ = -0.484, 95% CI = [-0.776, -0.022], *p* < 0.05). No other significant correlations for position error or angular error.


```{r loop-plot, include=TRUE, echo=FALSE}
ggplot(data = aim1_men_loop, aes(x = testosterone_spatial_ng_dl,
                                 y = loop_de_rad3_degree)) +
  
  #Define scatter, change size and alpha
  geom_point(color = "#00AFBB", size = 3, 
             alpha = 0.6, show.legend = FALSE) +
  
  #Add LM line
  geom_smooth(
              #method = 'loess',
              #formula = 'y ~ x',
              method = lm,
              #formula = y ~ splines::bs(x, 0.5),
              #formula = y ~ poly(x, 2),
              se = FALSE,
              color = "grey50") +
  
  #Change labels
  labs(x = "\nTestosterone (ng/dL)",
       y = expression(atop(paste(bold('Degree ('),
                                 bold(degree),
                                 bold(')')
                                 ))), 
       title = "Degrees Traveled at Radius 3.0m\n",
       #caption = "Smoothing applied using `method = lm` and `formula = y ~ poly(x, 2)`"
       ) +
  
  #Change theme
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(vjust = 2),
        axis.text = element_text(size= 10)) +
  
  #Add dashed grey line
  geom_hline(yintercept=360, linetype="dashed", color = "grey", size=1)

#save
#ggsave("study1_loop_de_testosterone_lm.png")
```



```{r loop-plot-outlier-rm, include=FALSE, echo=FALSE}
ggplot(data = men_loop_no354, aes(x = testosterone_spatial_ng_dl,
                                 y = loop_de_rad3_degree)) +
  
  #Define scatter, change size and alpha
  geom_point(color = "#00AFBB", size = 3, 
             alpha = 0.6, show.legend = FALSE) +
  
  #Add LM line
  geom_smooth(
              #method = 'loess',
              #formula = 'y ~ x',
              method = lm,
              #formula = y ~ splines::bs(x, 0.5),
              #formula = y ~ poly(x, 2),
              se = FALSE,
              color = "grey50") +
  
  #Change labels
  labs(x = "\nTestosterone (ng/dL)",
       y = expression(atop(paste(bold('Degree ('),
                                 bold(degree),
                                 bold(')')
                                 ))), 
       title = "Degrees Traveled at Radius 3.0m\n",
       #caption = "Smoothing applied using `method = lm` and `formula = y ~ poly(x, 2)`"
       ) +
  
  #Change theme
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"),
        plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(vjust = 2),
        axis.text = element_text(size= 10)) +
  
  #Add dashed grey line
  geom_hline(yintercept=360, linetype="dashed", color = "grey", size=1)

#save
#ggsave("study1_loop_de_testosterone_rm_lm.png")
```


### MAZE

```{r}
#Filter for men with maze and testosterone
aim1_men_maze <- aim1_men %>% 
  dplyr::select(subject_id, maze_useable, 
                maze_accuracy_pct, maze_moves, maze_path_efficiency,
                testosterone_spatial_ng_dl) %>% 
  filter(maze_useable == "Yes")
         #is.na(testosterone_spatial_ng_dl) != TRUE)
#n=23
aim1_men_maze %>% #group_by(repo_status) %>% 
  summarize(count = n(),
            mean_succ = mean(maze_accuracy_pct),
            sd_succ = sd(maze_accuracy_pct),
            mean_moves = mean(maze_moves),
            sd_moves = sd(maze_moves),
            mean_pe = mean(maze_path_efficiency),
            sd_pe = sd(maze_path_efficiency))

#Normality test
shapiro.test(aim1_men_maze$maze_accuracy_pct) #yes
shapiro.test(aim1_men_maze$maze_moves) #no
shapiro.test(aim1_men_maze$maze_path_efficiency) #no
shapiro.test(aim1_men_maze$testosterone_spatial_ng_dl) #no


########## spearman for accuracy
cor.test(aim1_men_maze$testosterone_spatial_ng_dl,
         aim1_men_maze$maze_accuracy_pct,
         conf.level = 0.95,
         method = "spearman")

########## Pearson for moves
cor.test(aim1_men_maze$testosterone_spatial_ng_dl,
         aim1_men_maze$maze_moves,
         conf.level = 0.95,
         method = "pearson")

########## Pearson for path efficiency
cor.test(aim1_men_maze$testosterone_spatial_ng_dl,
         aim1_men_maze$maze_path_efficiency,
         conf.level = 0.95,
         method = "pearson")
```

No significant correlations for accuracy, movees, or path efficiency.

 
### DSP

```{r}
#Filter for men with dsp and testosterone
aim1_men_dsp <- aim1_men %>% 
  dplyr::select(subject_id, dsp_useable, 
                dsp_success_pct, dsp_si_true_pct, 
                dsp_path_efficiency_grid_weighted,
                testosterone_spatial_ng_dl) %>% 
    filter(dsp_useable == "Yes")
         #is.na(testosterone_spatial_ng_dl) != TRUE)
#n=29

aim1_men_dsp %>%  #group_by(repo_status) %>% 
  summarize(count = n(),
            avg_succ = mean(dsp_success_pct),
            sd_succ = sd(dsp_success_pct),
            avg_si = mean(dsp_si_true_pct),
            sd_si = sd(dsp_si_true_pct),
            avg_pe = mean(dsp_path_efficiency_grid_weighted),
            sd_pe = sd(dsp_path_efficiency_grid_weighted))

#Normality test
shapiro.test(aim1_men_dsp$dsp_success_pct) #no
shapiro.test(aim1_men_dsp$dsp_si_true_pct) #yes
shapiro.test(aim1_men_dsp$dsp_path_efficiency_grid_weighted) #no
shapiro.test(aim1_men_dsp$testosterone_spatial_ng_dl) #no


########## pearson for wayfinding success
cor.test(aim1_men_dsp$testosterone_spatial_ng_dl,
         aim1_men_dsp$dsp_success_pct,
         conf.level = 0.95,
         method = "pearson")

########## spearman for si
cor.test(aim1_men$testosterone_spatial_ng_dl,
         aim1_men$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")

########## pearson for path efficiency
cor.test(aim1_men$testosterone_spatial_ng_dl,
         aim1_men$dsp_path_efficiency_grid_weighted,
         conf.level = 0.95,
         method = "pearson")
```

```{r}
#Get CI for rho testosterone
DescTools::SpearmanRho(aim1_men$testosterone_spatial_ng_dl,
                       aim1_men$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)
```


No significant correlations for wayfinding success, solution index, or path efficiency


## Women: Hormone and Behavior Correlations

Hormones bar plot using spatial hormones

```{r include=FALSE}
#Summary of hormones
ehormones_fig <- aim1_women %>% 
  group_by(repo_status) %>% 
  summarize(mean_estradiol = mean(estradiol_spatial_pg_ml, na.rm=T),
            sd_estradiol = sd(estradiol_spatial_pg_ml, na.rm=T),
            n_estradiol = n(),
            se_estradiol = sd(estradiol_spatial_pg_ml)/sqrt(n()), 
            .groups = "keep")
#Number of n for estradiol
ehormones_n <- aim1_women %>% 
  select(repo_status, estradiol_spatial_pg_ml) %>% 
  drop_na(estradiol_spatial_pg_ml) %>% 
  group_by(repo_status) %>% 
  dplyr::summarize(n_estradiol = n())
ehormones_n

phormones_fig <- aim1_women %>% 
  group_by(repo_status) %>% 
  summarize(mean_progesterone = mean(progesterone_spatial_ng_ml, na.rm=T),
            sd_progesterone = sd(progesterone_spatial_ng_ml, na.rm=T),
            n_progesterone = n(),
            se_progesterone = sd(progesterone_spatial_ng_ml)/sqrt(n()), 
            .groups = "keep")
phormones_n <- aim1_women %>% 
  select(repo_status, progesterone_spatial_ng_ml) %>% 
  drop_na(progesterone_spatial_ng_ml) %>% 
  group_by(repo_status) %>% 
  dplyr::summarize(n_progesterone = n())
phormones_n


fhormones_fig <- aim1_women %>% 
  group_by(repo_status) %>% 
  summarize(mean_estradiol = mean(fsh_spatial_miu_ml, na.rm=T),
            sd_estradiol = sd(fsh_spatial_miu_ml, na.rm=T),
            n_estradiol = n(),
            se_estradiol = sd(fsh_spatial_miu_ml)/sqrt(n()), 
            .groups = "keep")
fhormones_n <- aim1_women %>% 
  select(repo_status, fsh_spatial_miu_ml) %>% 
  drop_na(fsh_spatial_miu_ml) %>% 
  group_by(repo_status) %>% 
  dplyr::summarize(n_fsh = n())
fhormones_n
```


```{r hormone-barplot, include = TRUE, echo=FALSE}
#Estradiol plot
a <- ggplot(data = aim1_women, aes(x = repo_status, 
                            y = estradiol_spatial_pg_ml, 
                            fill = repo_status))+
  
  #Define bar plot by mean
  geom_bar(stat="summary", fun= "mean",
           show.legend = FALSE)+ 
  
  #Add SEM errorbar
  stat_summary(geom = "errorbar", 
               fun.data = mean_se,
               width = 0.15, size = 0.7)+
  
  #Change labels
  labs(
       x = "",
       # y = expression(atop(paste(bold("17"),
       #                           bold(beta),
       #                           bold("-Estradiol (pg/mL)")),
       #                     )),
       y = expression(paste(bold("17"),
                                 bold(beta),
                                 bold("-Estradiol (pg/mL)"))),
       tag = "A") +
  
  #Change colors of bars
  #Reverse color scale
  #scale_fill_brewer(palette = "RdPu",direction = -1)+
  
  #Change color of points
  scale_fill_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change theme
  theme_classic() +
  
  #Customize theme
  theme(axis.title = element_text(size = 13.5, face = "bold"), 
        axis.text = element_text(size= 13))

#ggsave("estradiol_bar.png")





#Progesterone plot
b <- ggplot(data = aim1_women, aes(x = repo_status,
                              y = progesterone_spatial_ng_ml,
                              fill = repo_status)) +
  
  #Define bar pplot by mean
  geom_bar(stat = "summary", fun = "mean",
           show.legend = FALSE) +
  
  #Add SEM errorbar
  stat_summary(geom = "errorbar", 
               fun.data = mean_se,
               width = 0.15, size = 0.7)+
  
  #Change labels
  labs(
       x = "",
       y = "Progesterone (ng/mL)\n",
       tag = "B") +
  
  #Change colors of bars
  #Reverse color scale
  #scale_fill_brewer(palette = "RdPu",direction = -1)+
  scale_fill_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change theme
  theme_classic() +
  
  #Customize theme
  theme(axis.title = element_text(size = 13.5, face = "bold"), 
        axis.text = element_text(size= 13))

#ggsave("progesterone_bar.png")


#FSH plot
c <- ggplot(data = aim1_women, aes(x = repo_status, 
                            y = fsh_spatial_miu_ml, 
                            fill = repo_status))+
  
  #Define bar plot by mean
  geom_bar(stat="summary", fun= "mean",
           show.legend = FALSE)+ 
  
  #Add SEM errorbar
  stat_summary(geom = "errorbar", 
               fun.data = mean_se,
               width = 0.15, size = 0.7)+
  
  #Change labels
  labs(
       x = "",
       y = "FSH (mIU/mL)\n",
       tag = "C") +
  
  #Change colors of bars
  #Reverse color scale
  #scale_fill_brewer(palette = "RdPu",direction = -1)+
  scale_fill_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change theme
  theme_classic() +
  
  #Customize theme
  theme(axis.title = element_text(size = 13.5, face = "bold"), 
        axis.text = element_text(size= 13))

#ggsave("fsh_bar.png")


#Show all 3 figs together
a+b+c + theme(axis.title.x=element_blank())
#ggsave("hormones_bar.png")
```


```{r hormone-boxplot, include = TRUE, echo=FALSE}
#Estradiol plot
a <- ggplot(data = aim1_women, aes(x = repo_status, 
                            y = estradiol_spatial_pg_ml, 
                            fill = repo_status))+
  
  #Add ends to whisker
  #stat_boxplot(geom = "errorbar", width = 0.5) + 
  
  #Add scatter points
  #Color by sex, add jitter width, change size and transparency
  #Remove legend for redundancy
  geom_jitter(aes(color = repo_status),
              position = position_jitter(width = .1),
              size = 3, alpha = 0.5,
              show.legend = FALSE) +
  
  #Define boxplot
  #Remove fill color and outlier points
  #Remove legend for redundancy
  geom_boxplot(aes(fill = repo_status), alpha = 0.6,
               outlier.color = NA,
               show.legend = FALSE) +

  #Add mean value for each sex for each site
  #Use point, change size and shape, change color and fill
  stat_summary(fun = mean, 
               geom = "point", 
               shape = 20, 
               size = 4, 
               color ="black", 
               fill="black") +
  
  #Change labels
  labs(
       x = "",
       # y = expression(atop(paste(bold("17"),
       #                           bold(beta),
       #                           bold("-Estradiol (pg/mL)")),
       #                     )),
       y = expression(paste(bold("17"),
                                 bold(beta),
                                 bold("-Estradiol (pg/mL)"))),
       tag = "A") +
  

  #Change color of boxplot
  scale_fill_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change color of jitter points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change theme
  theme_classic() +
  
  #Customize theme
  theme(axis.title = element_text(size = 13.5, face = "bold"), 
        axis.text = element_text(size= 13))

#ggsave("estradiol_box.png")


#Progesterone plot
b <- ggplot(data = aim1_women, aes(x = repo_status,
                              y = progesterone_spatial_ng_ml,
                              fill = repo_status)) +
  
   #Add ends to whisker
  #stat_boxplot(geom = "errorbar", width = 0.5) + 

  
  #Add scatter points
  #Color by sex, add jitter width, change size and transparency
  #Remove legend for redundancy
  geom_jitter(aes(color = repo_status),
              position = position_jitter(width = .1),
              size = 3, alpha = 0.5,
              show.legend = FALSE) +
  
  #Define boxplot
  #Remove fill color and outlier points
  #Remove legend for redundancy
  geom_boxplot(aes(fill = repo_status), alpha = 0.6,
               outlier.color = NA,
               show.legend = FALSE) +
  
  #Add mean value for each sex for each site
  #Use point, change size and shape, change color and fill
  stat_summary(fun = mean, 
               geom = "point", 
               shape = 20, 
               size = 4, 
               color ="black", 
               fill="black") +
  
  #Change labels
  labs(
       x = "",
       y = "Progesterone (ng/mL)",
       tag = "B") +
  
    #Change color of boxplot
  scale_fill_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change color of jitter points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change theme
  theme_classic() +
  
  #Customize theme
  theme(axis.title = element_text(size = 13.5, face = "bold"), 
        axis.text = element_text(size= 13))

#ggsave("progesterone_box.png")


#FSH plot
c <- ggplot(data = aim1_women, aes(x = repo_status, 
                            y = fsh_spatial_miu_ml, 
                            fill = repo_status))+
  
  #Add ends to whisker
  #stat_boxplot(geom = "errorbar", width = 0.5) + 
  
  #Add scatter points
  #Color by sex, add jitter width, change size and transparency
  #Remove legend for redundancy
  geom_jitter(aes(color = repo_status),
              position = position_jitter(width = .1),
              size = 3, alpha = 0.5,
              show.legend = FALSE) +
  
  #Define boxplot
  #Remove fill color and outlier points
  #Remove legend for redundancy
  geom_boxplot(aes(fill = repo_status), alpha = 0.6,
               outlier.color = NA,
               show.legend = FALSE) +
  
  #Add mean value for each sex for each site
  #Use point, change size and shape, change color and fill
  stat_summary(fun = mean, 
               geom = "point", 
               shape = 20, 
               size = 4, 
               color ="black", 
               fill="black") +
  
  #Change labels
  labs(
       x = "",
       y = "FSH (mIU/mL)",
       tag = "C") +
  
    #Change color of boxplot
  scale_fill_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change color of jitter points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  #Change theme
  theme_classic() +
  
  #Customize theme
  theme(axis.title = element_text(size = 13.5, face = "bold"), 
        axis.text = element_text(size= 13))

#ggsave("fsh_box.png")


#Show all 3 figs together
a+b+c + theme(axis.title.x=element_blank())
#ggsave("hormones_box.png")
```



```{r hormones-anova}
#ANOVA of hormones
hormone_mod <- aov(estradiol_spatial_pg_ml ~ repo_status,
      data = aim1_women)
summary(hormone_mod)
TukeyHSD(hormone_mod)

hormone_mod <- aov(progesterone_spatial_ng_ml ~ repo_status,
      data = aim1_women)
summary(hormone_mod)
TukeyHSD(hormone_mod)

hormone_mod2 <- aov(fsh_spatial_miu_ml ~ repo_status,
      data = aim1_women)
summary(hormone_mod2)
TukeyHSD(hormone_mod2)
```



```{r hormones-nonnormal}
#Kruskal-Wallis rank sum test for non-normal DV of one-way ANOVA

### Estradiol
kruskal.test(estradiol_spatial_pg_ml ~ repo_status,
      data = aim1_women) #p < 0.001
#Check pairwise comparisons using Wilcoxon rank sum test

# Benjamini, Hochberg, and Yekutieli control the false discovery rate, the expected proportion of false discoveries amongst the rejected hypotheses. The false discovery rate is a less stringent condition than the family-wise error rate, so these methods are more powerful than the others.
pairwise.wilcox.test(aim1_women$estradiol_spatial_pg_ml, 
                     aim1_women$repo_status,
                 p.adjust.method = "BH") #pre-peri < 0.01, rest < 0.001

### Progesterone
kruskal.test(progesterone_spatial_ng_ml ~ repo_status,
      data = aim1_women) #p = 0.0039
pairwise.wilcox.test(aim1_women$progesterone_spatial_ng_ml, 
                     aim1_women$repo_status,
                 p.adjust.method = "BH") #pre-peri not sig
#pre-post is 0.0055, peri-post is 0.035


### FSH
kruskal.test(fsh_spatial_miu_ml ~ repo_status,
      data = aim1_women) #p < 0.001
pairwise.wilcox.test(aim1_women$fsh_spatial_miu_ml, 
                     aim1_women$repo_status,
                 p.adjust.method = "BH") # all p < 0.001
```

Kruskal-Wallis rank sum test was used for non-normal comparison between reproductive groups for estradiol, progesterone, and FSH dependent variables. If significant, pairwise comparisons were made using Wilcoxon rank sum test with Benjamini, Hochberg, and Yekutieli *p*-adjustments to control the false discovery rate.

Estradiol is statistically significant between all pairs of reproductive groups (at least *p* < 0.01), as well as FSH (at least *p* < 0.001). Progesterone was different between pre-post (*p* < 0.01) and peri-post (*p* < 0.05).


```{r normality-check-women}
shapiro.test(aim1_women$loop_pe_rad3_m) #no
shapiro.test(aim1_women$loop_de_rad3_degree) #no
shapiro.test(aim1_women$loop_de_avg_degree) #no
shapiro.test(aim1_women$loop_ae_rad3_degree) #no
shapiro.test(aim1_women$loop_ae_avg_degree) #yes

shapiro.test(aim1_women$maze_accuracy_pct) #yes
shapiro.test(aim1_women$maze_moves) #yes
#shapiro.test(aim1_women$maze_path_efficiency) #tbd

shapiro.test(aim1_women$dsp_si_true_pct) #yes
shapiro.test(aim1_women$dsp_success_pct) #no
shapiro.test(aim1_women$dsp_path_efficiency_grid_weighted) #yes

shapiro.test(aim1_women$estradiol_spatial_pg_ml) #yes
shapiro.test(aim1_women$progesterone_spatial_ng_ml) #yes
shapiro.test(aim1_women$fsh_spatial_miu_ml) #yes

#LOOP dependent variables were not significant as well as DSP wayfinding success, but all other variables were significant, meaning that the normality assumption was violated.
```


Hormones were skewed despite log transformations, thus Spearman rank correlations were applied for all correlations between behavior and the raw hormone values.

### LOOP


```{r}
#Filter for women with loop and hormones
aim1_women_loop <- aim1_women %>% 
  dplyr::select(subject_id, repo_status, loop_useable, 
                loop_pe_rad3_m, 
                loop_de_rad3_degree, loop_de_avg_degree,
                loop_ae_rad3_degree, loop_ae_avg_degree,
                estradiol_spatial_pg_ml,
                progesterone_spatial_ng_ml,
                fsh_spatial_miu_ml) %>% 
  filter(loop_useable == "Yes")
#n=32

#N by repo status
aim1_women_loop %>% #group_by(repo_status) %>% 
  summarize(count = n(),
            mean_pe3 = mean(loop_pe_rad3_m, na.rm=T),
            sd_pe3 = sd(loop_pe_rad3_m, na.rm=T),
            mean_de3 = mean(loop_de_rad3_degree, na.rm=T),
            sd_de3 = sd(loop_de_rad3_degree, na.rm=T),
            mean_de_avg = mean(loop_de_avg_degree),
            sd_de_avg = sd(loop_de_avg_degree),
            mean_ae3 = mean(loop_ae_rad3_degree, na.rm=T),
            sd_ae3 = sd(loop_ae_rad3_degree, na.rm=T),
            mean_ae_avg = mean(loop_ae_avg_degree),
            sd_ae_avg = sd(loop_ae_avg_degree))


#Filter by available hormone
aim1_women_loop %>% filter(is.na(estradiol_spatial_pg_ml) != TRUE) %>% group_by(repo_status) %>% count() #32
aim1_women_loop %>% filter(is.na(progesterone_spatial_ng_ml) != TRUE) %>% group_by(repo_status) %>%  count() #26
aim1_women_loop %>% filter(is.na(fsh_spatial_miu_ml) != TRUE) %>% group_by(repo_status) %>% count() #26

#Normality test
shapiro.test(aim1_women_loop$loop_pe_rad3_m) #no
shapiro.test(aim1_women_loop$loop_de_rad3_degree) #no
shapiro.test(aim1_women_loop$loop_de_avg_degree) #no
shapiro.test(aim1_women_loop$loop_ae_rad3_degree) #no
shapiro.test(aim1_women_loop$loop_ae_avg_degree) #yes
shapiro.test(aim1_women_loop$estradiol_spatial_pg_ml) #yes
shapiro.test(aim1_women_loop$progesterone_spatial_ng_ml) #yes
shapiro.test(aim1_women_loop$fsh_spatial_miu_ml) #yes


########## Spearman for position error 3.0m
cor.test(aim1_women_loop$estradiol_spatial_pg_ml,
         aim1_women_loop$loop_pe_rad3_m,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$progesterone_spatial_ng_ml,
         aim1_women_loop$loop_pe_rad3_m,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$fsh_spatial_miu_ml,
         aim1_women_loop$loop_pe_rad3_m,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for degrees traveled 3.0m
cor.test(aim1_women_loop$estradiol_spatial_pg_ml,
         aim1_women_loop$loop_de_rad3_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$progesterone_spatial_ng_ml,
         aim1_women_loop$loop_de_rad3_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$fsh_spatial_miu_ml,
         aim1_women_loop$loop_de_rad3_degree,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for degrees traveled avg
cor.test(aim1_women_loop$estradiol_spatial_pg_ml,
         aim1_women_loop$loop_de_avg_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$progesterone_spatial_ng_ml,
         aim1_women_loop$loop_de_avg_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$fsh_spatial_miu_ml,
         aim1_women_loop$loop_de_avg_degree,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for angular error 3.0m
cor.test(aim1_women_loop$estradiol_spatial_pg_ml,
         aim1_women_loop$loop_ae_rad3_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$progesterone_spatial_ng_ml,
         aim1_women_loop$loop_ae_rad3_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$fsh_spatial_miu_ml,
         aim1_women_loop$loop_ae_rad3_degree,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for angular error avg
cor.test(aim1_women_loop$estradiol_spatial_pg_ml,
         aim1_women_loop$loop_ae_avg_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$progesterone_spatial_ng_ml,
         aim1_women_loop$loop_ae_avg_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women_loop$fsh_spatial_miu_ml,
         aim1_women_loop$loop_ae_avg_degree,
         conf.level = 0.95,
         method = "spearman")
```
No significant correlations for position error, degrees traveled, or angular error.


### MAZE

```{r}
#Filter for women with maze and hormones
aim1_women_maze <- aim1_women %>% 
  dplyr::select(subject_id, repo_status, maze_useable, 
                maze_accuracy_pct, maze_moves, maze_path_efficiency,
                estradiol_spatial_pg_ml,
                progesterone_spatial_ng_ml,
                fsh_spatial_miu_ml) %>% 
  filter(maze_useable == "Yes")
#n=64

#Group by repo status
aim1_women_maze %>% #group_by(repo_status) %>% 
  summarize(count = n(),
            mean_succ = mean(maze_accuracy_pct),
            sd_succ = sd(maze_accuracy_pct),
            mean_moves = mean(maze_moves),
            sd_moves = sd(maze_moves),
            mean_pe = mean(maze_path_efficiency),
            sd_pe = sd(maze_path_efficiency))


#Filter by available hormone
aim1_women_maze %>% filter(is.na(estradiol_spatial_pg_ml) != TRUE) %>% count() #64
aim1_women_maze %>% filter(is.na(progesterone_spatial_ng_ml) != TRUE) %>% count() #61
aim1_women_maze %>% filter(is.na(fsh_spatial_miu_ml) != TRUE) %>% count() #61

#Normality test
shapiro.test(aim1_women_maze$maze_accuracy_pct) #yes
shapiro.test(aim1_women_maze$maze_moves) #yes
shapiro.test(aim1_women_maze$maze_path_efficiency) #yes
shapiro.test(aim1_women_maze$estradiol_spatial_pg_ml) #yes
shapiro.test(aim1_women_maze$progesterone_spatial_ng_ml) #yes
shapiro.test(aim1_women_maze$fsh_spatial_miu_ml) #yes


##### Men vs women MOVES
#p=0.09
wilcox.test(aim1_men_maze$maze_moves, 
            aim1_women_maze$maze_moves,
            paired=FALSE, exact=FALSE, conf.int=TRUE)
median(aim1_men_maze$maze_moves) #275
median(aim1_women_maze$maze_moves) #268


########## Spearman for wayfinding success
#Estradiol
cor.test(aim1_women_maze$estradiol_spatial_pg_ml,
         aim1_women_maze$maze_accuracy_pct,
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_maze$progesterone_spatial_ng_ml,
         aim1_women_maze$maze_accuracy_pct,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(aim1_women_maze$fsh_spatial_miu_ml,
         aim1_women_maze$maze_accuracy_pct,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for moves

#Estradiol
cor.test(aim1_women_maze$estradiol_spatial_pg_ml,
         aim1_women_maze$maze_moves,
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_maze$progesterone_spatial_ng_ml,
         aim1_women_maze$maze_moves,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(aim1_women_maze$fsh_spatial_miu_ml,
         aim1_women_maze$maze_moves,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for path efficiency

#Estradiol
cor.test(aim1_women_maze$estradiol_spatial_pg_ml,
         aim1_women_maze$maze_path_efficiency,
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_maze$progesterone_spatial_ng_ml,
         aim1_women_maze$maze_path_efficiency,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(aim1_women_maze$fsh_spatial_miu_ml,
         aim1_women_maze$maze_path_efficiency,
         conf.level = 0.95,
         method = "spearman")
```

No correlations for accuracy, moves, or path efficiency.


### DSP

```{r}
#Filter for women with dsp and hormones
aim1_women_dsp <- aim1_women %>% 
  dplyr::select(subject_id, repo_status, dsp_useable, 
                dsp_success_pct, dsp_si_true_pct, 
                dsp_path_efficiency_grid_weighted,
                estradiol_spatial_pg_ml,
                progesterone_spatial_ng_ml,
                fsh_spatial_miu_ml) %>% 
  filter(dsp_useable == "Yes")
#n=47

#Group by repo status
aim1_women_dsp %>%  #group_by(repo_status) %>% 
  summarize(count = n(),
            avg_succ = mean(dsp_success_pct),
            sd_succ = sd(dsp_success_pct),
            avg_si = mean(dsp_si_true_pct),
            sd_si = sd(dsp_si_true_pct),
            avg_pe = mean(dsp_path_efficiency_grid_weighted),
            sd_pe = sd(dsp_path_efficiency_grid_weighted))


#Filter by available hormone
aim1_women_dsp %>% filter(is.na(estradiol_spatial_pg_ml) != TRUE) %>% count() #47
aim1_women_dsp %>% filter(is.na(progesterone_spatial_ng_ml) != TRUE) %>% count() #46
aim1_women_dsp %>% filter(is.na(fsh_spatial_miu_ml) != TRUE) %>% count() #46


#Normality test
shapiro.test(aim1_women_dsp$dsp_success_pct) #no
shapiro.test(aim1_women_dsp$dsp_si_true_pct) #yes
shapiro.test(aim1_women_dsp$dsp_path_efficiency_grid_weighted) #yes
shapiro.test(aim1_women_dsp$estradiol_spatial_pg_ml) #yes
shapiro.test(aim1_women_dsp$progesterone_spatial_ng_ml) #yes
shapiro.test(aim1_women_dsp$fsh_spatial_miu_ml) #yes

#Log
shapiro.test(sqrt(aim1_women_dsp$dsp_si_true_pct)) #yes
shapiro.test(sqrt(aim1_women_dsp$estradiol_spatial_pg_ml)) #yes
shapiro.test(sqrt(aim1_women_dsp$fsh_spatial_miu_ml)) #yes


########## Spearman for wayfinding success

#Estradiol
cor.test(aim1_women_dsp$estradiol_spatial_pg_ml,
         aim1_women_dsp$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_dsp$progesterone_spatial_ng_ml,
         aim1_women_dsp$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(aim1_women_dsp$fsh_spatial_miu_ml,
         aim1_women_dsp$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")


########## Spearman for solution index
#Estradiol
cor.test(aim1_women_dsp$estradiol_spatial_pg_ml,
         aim1_women_dsp$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_dsp$progesterone_spatial_ng_ml,
         aim1_women_dsp$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(aim1_women_dsp$fsh_spatial_miu_ml,
         aim1_women_dsp$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")



######### Pearson for transformed E and FSH
#Estradiol
cor.test(log(aim1_women_dsp$estradiol_spatial_pg_ml),
         log(aim1_women_dsp$dsp_si_true_pct),
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_dsp$progesterone_spatial_ng_ml,
         aim1_women_dsp$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(log(aim1_women_dsp$fsh_spatial_miu_ml),
         aim1_women_dsp$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")




########## Spearman for path efficiency
#Estradiol
cor.test(aim1_women_dsp$estradiol_spatial_pg_ml,
         aim1_women_dsp$dsp_path_efficiency_grid_weighted,
         conf.level = 0.95,
         method = "spearman")
#Progesterone
cor.test(aim1_women_dsp$progesterone_spatial_ng_ml,
         aim1_women_dsp$dsp_path_efficiency_grid_weighted,
         conf.level = 0.95,
         method = "spearman")
#FSH
cor.test(aim1_women_dsp$fsh_spatial_miu_ml,
         aim1_women_dsp$dsp_path_efficiency_grid_weighted,
         conf.level = 0.95,
         method = "spearman")
```


No correlation for wayfinding success or path efficiency, but significant positive correlation for solution index for estradiol ($\rho$ = 0.421, *p* < 0.01) and negative marginal correlation for FSH ($\rho$ = -0.281, *p* = 0.058).

```{r dsp-women-si}
#Get CI for rho estradiol
DescTools::SpearmanRho(aim1_women_dsp$estradiol_spatial_pg_ml,
                       aim1_women_dsp$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)

#Get CI for rho FSH
DescTools::SpearmanRho(aim1_women_dsp$fsh_spatial_miu_ml,
                       aim1_women_dsp$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)

#Get CI for rho progesterone
DescTools::SpearmanRho(aim1_women_dsp$progesterone_spatial_ng_ml,
                       aim1_women_dsp$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)
```


```{r dsp-anova-kruskal}
#ANOVA
si_mod <- aov(dsp_si_true_pct ~ repo_status,
              data = aim1_women_dsp)
summary(si_mod)


#Kruskal-Wallis test
kruskal.test(dsp_si_true_pct ~ repo_status,
              data = aim1_women_dsp) #not significant 
```

Kruskal-Wallis test of DSP solution index by reproductive status for women was not significant.


```{r ttest-dsp-si, include=FALSE}
#Number of place strategies overall?
dsp_df <- read_csv(here("data", "dsp_midlife_behavior_variables.csv")) %>% 
  clean_names() %>% 
  rename(subject_id = subject_number)

#Merge aim1 and dsp
dsp_merge_m <- merge(aim1_men_dsp, dsp_df, by.x = "subject_id")
dsp_merge_f <- merge(aim1_women_dsp, dsp_df, by.x = "subject_id")


#Men number of place strategies
dsp_merge_m <- dsp_merge_m %>% 
  mutate(place_prop = shortcuts_total/success,
         response_prop = learned_total/success)
#Show
dsp_merge_m %>% 
  mutate(place_prop = shortcuts_total/success,
         response_prop = learned_total/success) %>% 
  dplyr::summarize(mean_place = mean(place_prop),
                   sd_place = sd(place_prop),
                   mean_response = mean(response_prop),
                   sd_response = sd(response_prop),
                   mean_ratio = mean_place/mean_response)

#Women number of place strategies
dsp_merge_f <- dsp_merge_f %>% 
  mutate(place_prop = shortcuts_total/success,
         response_prop = learned_total/success)
#Show
dsp_merge_f %>% group_by(repo_status) %>% 
    mutate(place_prop = shortcuts_total/success,
         response_prop = learned_total/success) %>% 
  dplyr::summarize(mean_place = mean(place_prop),
                   sd_place = sd(place_prop),
                   mean_response = mean(response_prop),
                   sd_response = sd(response_prop),
                   mean_ratio = mean_place/mean_response)

#Normality check for proportion place in men vs women
shapiro.test(dsp_merge_m$place_prop) #no
shapiro.test(dsp_merge_f$place_prop) #yes

#Not sig, p=0.7, W=718
#Mann Whitney U
wilcox.test(dsp_merge_m$place_prop, 
            dsp_merge_f$place_prop,
            paired=FALSE, exact=FALSE, conf.int=TRUE)
median(dsp_merge_m$place_prop) #0.273
median(dsp_merge_f$place_prop) #0.267

#########
#After checking differences in table for men vs women
#both non-normal so use Wilcoxon rank sum
wilcox.test(aim1_men_dsp$dsp_si_true_pct,
       aim1_women_dsp$dsp_si_true_pct) #p=0.135
median(aim1_men_dsp$dsp_si_true_pct) #0.1818182
median(aim1_women_dsp$dsp_si_true_pct) #0.25
```


```{r test-wayfinding}
t.test(aim1_men_dsp$dsp_success_pct,
       aim1_women_dsp$dsp_si_true_pct,conf.level = 0.95)
# aov_succ <- aov(dsp_si_true_pct ~ repo_status, data=aim1_women_dsp)
# summary(aov_succ)
```


```{r dsp-plot, include = TRUE, echo=FALSE}
#E and FSH plot with SI
#n=46 FSH, n=47 estradiol
aim1_women_dsp <- aim1_women %>% 
  dplyr::select(dsp_useable, dsp_success_pct, dsp_si_true_pct,
                repo_status,
                estradiol_spatial_pg_ml,
                progesterone_spatial_ng_ml,
                fsh_spatial_miu_ml) %>% 
  filter(dsp_useable == "Yes")

a <- ggplot(data = aim1_women_dsp, aes(x = estradiol_spatial_pg_ml,
                                        y = dsp_si_true_pct)) +
  
  #Define scatter, change size and alpha
  geom_point(aes(color = repo_status),
             size = 3, alpha = 0.6, show.legend = FALSE) +
  
  #Add LM line
  geom_smooth(
    method = lm, 
    #formula = y ~ poly(x, 2),
    #method = "gam", formula = y ~ s(x, bs = "cs"),
              se = FALSE,
              color = "grey50") +
  
  #Change labels
  labs(x = expression(paste(bold("17"),
                            bold(beta),
                            bold("-Estradiol (pg/mL)"))
                      ),
       y = "Solution Index (%)\n",
       color = "Reproductive Status") +
  
  #Change color of points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"), 
        axis.title.x = element_text(vjust = -0.5),
        axis.text = element_text(size= 10))



b <- ggplot(data = aim1_women_dsp, aes(x = fsh_spatial_miu_ml,
                            y = dsp_si_true_pct,
                            color = repo_status)) +
  
  #Define scatter, change size and alpha
  geom_point(aes(color = repo_status),
             size = 3, alpha = 0.6) +
  
  #Add LM line
  geom_smooth(
    method = lm, 
    #formula = y ~ poly(x, 2),
    #method = "gam", formula = y ~ s(x, bs = "cs"),
              se = FALSE,
              color = "grey50") +
  
  #Change labels
  labs(x = "\nFSH (mIU/mL)",
       y = " ",
       color = "Reproductive Status"
       #caption = "Smoothing applied using `method = lm` and `formula = y ~ poly(x, 2)`"
       ) +
  
  #Change color of points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"),
        axis.title.x = element_text(vjust = 2),
        axis.text = element_text(size= 10),
        
        #Legend
        #legend.title = element_text(face = "bold"),
        legend.position = "top"
        
        )


#Combine
combined <- a + b & theme(legend.position = "top")
combined + plot_layout(guides = "collect")

#save
#ggsave("study1_dsp_si_estradiol_fsh_lm.png")
```


```{r dsp-plot-emily, include=FALSE}
#E and FSH plot with SI
#n=46

a <- ggplot(data = aim1_women_dsp, aes(x = estradiol_spatial_pg_ml,
                                        y = dsp_si_true_pct)) +
  
  #Define scatter, change size and alpha
  geom_point(size = 3, alpha = 0.6, color = "black",
             show.legend = FALSE) +
  
  #Add LM line
  geom_smooth(method = lm, se = TRUE,
              color = "blue") +
  
  #Change labels
  labs(x = expression(paste(bold("17"),
                            bold(beta),
                            bold("-Estradiol (pg/mL)"))
                      ),
       y = "Solution Index\n") +
  
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"), 
        axis.title.x = element_text(vjust = -0.5),
        axis.text = element_text(size= 10))



b <- ggplot(data = aim1_women_dsp, aes(x = fsh_spatial_miu_ml,
                            y = dsp_si_true_pct)) +
  
  #Define scatter, change size and alpha
  geom_point(size = 3, alpha = 0.6, color = "black") +
  
  #Add LM line
  geom_smooth(method = lm, se = TRUE,
              color = "blue") +
  
  #Change labels
  labs(x = "\nFSH (mIU/mL)",
       y = " ") +
  
  
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"),
        axis.title.x = element_text(vjust = 2),
        axis.text = element_text(size= 10),
        
        #Legend
        #legend.title = element_text(face = "bold"),
        legend.position = "top"
        
        )


#Combine
combined <- a + b & theme(legend.position = "top")
combined + plot_layout(guides = "collect")


#save
#ggsave("study1_dsp_si_estradiol_fsh.png")
```

```{r include=FALSE}
a <- ggscatter(aim1_women_dsp, 
          x = "fsh_spatial_miu_ml", y = "dsp_si_true_pct",
          add = "reg.line",
          add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
          cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
          conf.int = TRUE, 
          cor.method = "spearman",
          cor.coeff.args = list(label.sep = "\n"),
          xlab = "FSH (mIU/mL)", ylab = "Solution Index") 

b <- ggscatter(aim1_women_dsp, 
          x = "estradiol_spatial_pg_ml", y = "dsp_si_true_pct",
          add = "reg.line",
          add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
          cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
          conf.int = TRUE, 
          cor.method = "spearman",
          cor.coeff.args = list(label.sep = "\n"),
          xlab = "Estradiol (pg/mL)", ylab = "Solution Index") 

a+b

#ggsave("dsp_si_for_emily.png")
```


```{r results='hide'}

aim1_women_dsp_ratio <- aim1_women_dsp %>% 
  select(subject_id, repo_status, fsh_e_ratio, 
         estradiol_spatial_pg_ml, fsh_spatial_miu_ml,
         dsp_success_pct, dsp_si_true_pct)

#Check distribution of E:FSH ratio (probably not normal)
shapiro.test(aim1_women_dsp_ratio$e_fsh_ratio) #yes
shapiro.test(log(aim1_women$e_fsh_ratio)) #yes

shapiro.test(aim1_women_dsp_ratio$fsh_e_ratio) #yes
shapiro.test(log(aim1_women$fsh_e_ratio)) #yes

#All correlations need to be Spearman rank


###### Check remove outlier for FSH:E in SI
aim1_dsp_ratio_rm <- aim1_women_dsp_ratio %>% 
  filter(subject_id != "327") #n=46
shapiro.test(aim1_dsp_ratio_rm$fsh_e_ratio)
cor.test(aim1_dsp_ratio_rm$fsh_e_ratio,
         aim1_dsp_ratio_rm$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman") #still significant, p=0.00972
#Get CI for rho
DescTools::SpearmanRho(aim1_dsp_ratio_rm$fsh_e_ratio,
                       aim1_dsp_ratio_rm$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)
```


```{r ratio-correlations}
### LOOP
#Correlation with E:FSH and FSH:E ratio
########## Spearman for position error
cor.test(aim1_women$e_fsh_ratio,
         aim1_women$loop_pe_avg_m,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women$fsh_e_ratio,
         aim1_women$loop_pe_avg_m,
         conf.level = 0.95,
         method = "spearman")

########## Spearman for degrees traveled
cor.test(aim1_women$e_fsh_ratio,
         aim1_women$loop_de_avg_degree,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women$fsh_e_ratio,
         aim1_women$loop_de_avg_degree,
         conf.level = 0.95,
         method = "spearman")



### MAZE
#Correlation with E:FSH ratio
########## Spearman for wayfinding success
cor.test(aim1_women$e_fsh_ratio,
         aim1_women$maze_accuracy_pct,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women$fsh_e_ratio,
         aim1_women$maze_accuracy_pct,
         conf.level = 0.95,
         method = "spearman")

########## Spearman for moves
cor.test(aim1_women$e_fsh_ratio,
         aim1_women$maze_moves,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women$fsh_e_ratio,
         aim1_women$maze_moves,
         conf.level = 0.95,
         method = "spearman")


### DSP
#Correlation with E:FSH ratio
########## Spearman for wayfinding success
cor.test(aim1_women$e_fsh_ratio,
         aim1_women$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women$fsh_e_ratio,
         aim1_women$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")

########## Spearman for solution index
cor.test(aim1_women$e_fsh_ratio,
         aim1_women$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
cor.test(aim1_women$fsh_e_ratio,
         aim1_women$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
#Solution index is still significant with the ratios 
```


```{r dsp-ratio-ci}
#Count sample size for ratio
aim1_women %>%
  select(e_fsh_ratio) %>% 
  summarize(count = sum(!is.na(e_fsh_ratio))) #74-6 = 
#Get CI for rho
DescTools::SpearmanRho(aim1_women$e_fsh_ratio,
                       aim1_women$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)


test <- aim1_women %>%
  select(dsp_useable, estradiol_spatial_pg_ml,
         fsh_spatial_miu_ml, fsh_e_ratio) 
test %>% filter(dsp_useable == "Yes") %>% 
  summarize(count = sum(!is.na(fsh_e_ratio)))
#Get CI for rho
DescTools::SpearmanRho(aim1_women$fsh_e_ratio,
                       aim1_women$dsp_si_true_pct,
                       use = "complete.obs",
                       conf.level	= 0.95)
```



```{r dsp-plot-ratio, results='hide'}
### Estradiol to FSH ratio (spatial) in Midlife Women
#Midlife women

#Create new column with ratio
aim1_women <- aim1_women %>% 
  mutate(e_fsh_ratio = estradiol_spatial_pg_ml/fsh_spatial_miu_ml,
         fsh_e_ratio = fsh_spatial_miu_ml/estradiol_spatial_pg_ml)


#Filter for DSP
aim1_women_dsp <- aim1_women %>% 
  filter(dsp_useable == "Yes")
  

#Plot E:FSH ratio and solution index
ggplot(data = aim1_women_dsp, aes(x = as.numeric(e_fsh_ratio),
                            y = dsp_si_true_pct,
                            #text = subject_id
                            )) +
  
  #Define scatter, change size and alpha
  geom_point(aes(color = repo_status),
             size = 3, alpha = 0.6) +
  
  #Add LM line
  geom_smooth(method = "lm", se = FALSE,
              color = "grey50") +
  
  #Change labels
  labs(x = "\nEstradiol to FSH Ratio",
       y = "Solution Index (%)",
       color = "Reproductive Status") +
  
  #Change color of points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"),
        axis.title.x = element_text(vjust = 2),
        axis.text = element_text(size= 10),
        
        #Legend
        #legend.title = element_text(face = "bold"),
        legend.position = "top")




#Plot FSH:E ratio and solution index
ggplot(data = aim1_dsp_ratio_rm, aes(x = as.numeric(fsh_e_ratio),
                            y = dsp_si_true_pct,
                            #text = subject_id
                            )) +
  
  #Define scatter, change size and alpha
  geom_point(aes(color = repo_status),
             size = 3, alpha = 0.6) +
  
  #Add LM line
  geom_smooth(method = "lm", se = FALSE, color = "grey50") +
  
  #Change labels
  labs(x = "\nFSH:E Ratio",
       y = "Solution Index (%)\n",
       color = "Reproductive Status") +
  
  #Change color of points
  scale_color_manual(values = c("cadetblue4", "mediumvioletred", "darkorange")) +
  
  theme_minimal() +
  
  #Customize theme
  theme(axis.title = element_text(size = 11, face = "bold"),
        axis.title.x = element_text(vjust = 2),
        axis.text = element_text(size= 10),
        
        #Legend
        #legend.title = element_text(face = "bold"),
        legend.position = "top")

ggsave("f_e_ratio.png")
```




```{r, results='hide'}

## Behavior for Young and Midlife (HAS, SNAG, OHS)

#Visualizations


#Combine dataframes
long_viz <- df_all %>% 
  select(subject_id, completed_spatial, sex, age_group,
         age_spatial_years, repo_status, straw_status,
         loop_useable:dsp_si_true_pct)
```


```{r, results='hide'}
#LOOP
long_viz_loop <- long_viz %>% 
  filter(loop_useable == "Yes")

#Scatterpot 
a1 <- ggplot(data = long_viz_loop, aes(x = age_spatial_years,
                                 y = loop_pe_avg_m)) +
  geom_point(aes(color = sex), size = 2, alpha = 0.6) +
  geom_smooth(aes(group = sex, color = sex), method = "lm", 
              formula = y ~ poly(x, 2),
              position = "identity") +
  labs(x = "Age (years)",
       y = "Mean position error (m)",
       color = "Sex") +
  theme_minimal()+
  theme(legend.position = c(0.3, 0.9))


a2 <- ggplot(data = long_viz_loop, aes(x = age_spatial_years,
                                 y = loop_de_avg_degree)) +
  geom_point(aes(color = sex), size = 2, alpha = 0.6,
             show.legend = FALSE) +
  geom_smooth(aes(group = sex, color = sex), method = "lm", 
              position = "identity", show.legend = FALSE) +
  labs(x = "Age (years)",
       y = "Mean degrees traveled",
       color = "Sex") +
  theme_minimal()

#Display combination
a1+a2
```



```{r, results='hide'}
#MAZE
long_viz_maze <- long_viz %>% 
  filter(maze_useable == "Yes")

#Scatterpot 
a1 <- ggplot(data = long_viz_maze, aes(x = age_spatial_years,
                                 y = maze_accuracy_pct)) +
  geom_point(aes(color = sex), size = 2, alpha = 0.6,
             show.legend = FALSE) +
  geom_smooth(aes(group = sex, color = sex), method = "lm", 
              position = "identity", show.legend = FALSE) +
  labs(x = "Age (years)",
       y = "Accuracy (%)",
       color = "Sex") +
  theme_minimal()

a2 <- ggplot(data = long_viz_maze, aes(x = age_spatial_years,
                                      y = maze_moves)) +
  geom_point(aes(color = sex), size = 2, alpha = 0.6) +
  geom_smooth(aes(group = sex, color = sex), method = "lm", position = "identity") +
  labs(x = "Age (years)",
       y = "Number of Moves",
       color = "Sex") +
  theme_minimal() +
  theme(legend.position = c(0.3, 0.1))

#Display
a1+a2
```


```{r, results='hide'}
#DSP
long_viz_dsp <- long_viz %>% 
  filter(dsp_useable == "Yes")

#Scatterpot with curve
a1 <- ggplot(data = long_viz_dsp, aes(x = age_spatial_years,
                                 y = dsp_success_pct)) +
  geom_point(aes(color = sex), size = 2, alpha = 0.6) +
  geom_smooth(aes(group = sex, color = sex), method = "lm", position = "identity") +
  labs(x = "Age (years)",
       y = "Wayfinding Success (%)",
       color = "Sex") +
  theme_minimal()+
  theme(legend.position = c(0.2, 0.1))

a2 <- ggplot(data = long_viz_dsp, aes(x = age_spatial_years,
                                 y = dsp_si_true_pct)) +
  geom_point(aes(color = sex), size = 2, alpha = 0.6,
             show.legend = FALSE) +
  geom_smooth(aes(group = sex, color = sex), method = "lm", 
              position = "identity", show.legend = FALSE) +
  labs(x = "Age (years)",
       y = "Solution Index (%)",
       color = "Sex") +
  theme_minimal() 

#Display
a1+a2
```



```{r post-analyses, include=FALSE}
######### Sex differences

### LOOP ###

#Radius 3: n=31 for women and n=19 men

#Position error at radius 3
t.test(aim1_men_loop$loop_pe_rad3_m,
       aim1_women_loop$loop_pe_rad3_m, conf.level = 0.95) #p = 0.6086

#Degrees at radius 3
wilcox.test(aim1_men_loop$loop_de_rad3_degree,
            aim1_women_loop$loop_de_rad3_degree, 
            paired=FALSE, exact=FALSE, conf.int=TRUE, conf.level = 0.95) #p=0.01146
median(aim1_men_loop$loop_de_rad3_degree, na.rm=TRUE) #317.7333
median(aim1_women_loop$loop_de_rad3_degree, na.rm=TRUE) #397.1856


#outlier removed for men so they are n=18, and normal so use t-test
t.test(men_loop_no354$loop_de_rad3_degree,
       aim1_women_loop$loop_de_rad3_degree, conf.level = 0.95) #p=0.003443



### MAZE ###
#Accuracy
wilcox.test(aim1_men_maze$maze_accuracy_pct,
            aim1_women_maze$maze_accuracy_pct, 
            paired=FALSE, exact=FALSE, conf.int=TRUE, conf.level = 0.95) #p=0.1231

#Moves
wilcox.test(aim1_men_maze$maze_moves,
            aim1_women_maze$maze_moves, 
            paired=FALSE, exact=FALSE, conf.int=TRUE, conf.level = 0.95) #p=0.09023


### DSP ###
t.test(aim1_men_dsp$dsp_success_pct,
       aim1_women_dsp$dsp_success_pct, conf.level = 0.95) #p = 0.028

#After checking differences in table for men vs women
#both non-normal so use Wilcoxon rank sum
wilcox.test(aim1_men_dsp$dsp_si_true_pct,
            aim1_women_dsp$dsp_si_true_pct, 
            paired=FALSE, exact=FALSE, conf.int=TRUE, conf.level = 0.95) #p=0.135
median(aim1_men_dsp$dsp_si_true_pct) #0.1818182
median(aim1_women_dsp$dsp_si_true_pct) #0.25
```



# Summary


- Men were tested separately for the relationship between testosterone and spatial navigation behaviors, while women were tested for the relationships between estradiol, progesterone, FSH and spatial navigation behaviors.

- LOOP degrees traveled at 3.0m was negatively correlation with testosterone for men ($\rho$ = -0.484, 95% CI = [-0.776, -0.022], *p* < 0.05).

- Estradiol, progesterone, and FSH were skewed, so associations with these hormones were using Spearman rank correlations.

- No significant correlations for LOOP or MAZE among women.

- While there were no significant correlations for DSP wayfinding success or path efficiency, there was a positive correlation between estradiol and solution index ($\rho$ = 0.421, 95% CI = [0.153, 0.632], *p* < 0.01, Spearman), and a marginal negative association between FSH and solution index ($\rho$ = -0.281, 95% CI = [-0.529, 0.010], *p* = 0.058, Spearman). There was also no significant correlation with progesterone and solution index ($\rho$ = 0.16, 95% CI = [-0.136, 0.431], *p* = 0.29, Spearman). This was true when using hormone measurements from spatial timepoints.

- Kruskla-Wallis test reveals that DSP solution index by reproductive status was not significant. 

- When using estradiol to FSH ratio (or FSH to estradiol ratio) as a single measure for hormone concentration, the relationship with DSP solution index remained significant ($\rho$ = 0.420, 95% CI = [0.148, 0.633], *p* < 0.01, Spearman).



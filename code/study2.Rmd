---
title: 'Study 2: Causal Mediation Analysis'
author: "Shuying Yu"
date: "9/26/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 6
    theme: flatly
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center")

#Attach libraries
library(tidyverse)
library(here)
library(janitor)
library(ggpubr)
library(patchwork)
library(kableExtra)
library(foreign)
library(RColorBrewer)
library(plotly)
library(readr)
library(broom)
library(GGally)
library(psych)

#Medaition packages
library(lavaan)
library(mediation)
library(blavaan)
```


# Introduction

## Overview

**Total Effect (IV, Hormone to DV, Behavior):**

Study 1 (aka "Study 2, part 1") has shown that there is a correlation between sex hormones and spatial navigation strategy (`study1.Rmd`), such that higher estradiol is positively associated with higher use of shortcuts in the DSP task (higher solution index). Higher FSH, on the other hand, was marginally negatively associated with shortcut use (lower solution index) using Spearman rank correlations.

**Effect of IV (Hormone) on Mediator:**

Prior exploratory analysis for relationships between sex hormones and T2 subfield volume reveal certain significant relationships (`correlation_t2_hormones.Rmd`). Highlights of the results show that progesterone and FSH were associated with multiple subfields (e.g., CA1, CA23, ERC, DG, total hipp and MTL), whereas estradiol was only associated with ERC PHC and PRC. 

For T1 hippocampal volume (`correlation_t1_hormones.Rmd`), only DHEAS was negatively correlated with volume for post-menopausal women (Spearman). 

Significant effect of hormones on the mediator (T2 subfields or T1 hippocampal volume) is an absolute prerequisite for mediation being possible.


**Other**


Following the correlations between hormones and brain structure, I explored the associations between brain structure and spatial navigation behaviors (`correlation_t2_hormones.Rmd` and `correlation_t1_hormones.Rmd`). Results revealed that most subfield volumes except PHC were negatively associated with LOOP degrees traveled overall and for men. DSP solution index was mostly tied to CA23 and DG, whereas DSP wayfinding success was mainly tied to ERC. 

For T1 hippocampal volume, women overall and pre-menopausal women with higher grey matter volume correlated with fewer degrees traveled in LOOP. Also within LOOP, larger grey mater was positively correlated with position error for pre-menopausal women. Overall, greater volume was associated with lower wayfinding success in DSP. Higher DSP solution index was marginally positively associated with pre-manopausal women who had higher grey matter volume.


# Research Question

Are there indirect effects, such that hippocampal grey matter volume mediates the relationship between sex hormones and spatial navigation behavior (specifically, navigation strategy)?

# Methods

Here, I determine how T1 hippocampal and T2 subfield volume mediate the relationship between sex hormones and behavior for navigation strategy. I will investigate whether there are any relationships between spatial navigation behaviors and T1 hippocampal and T2 subfield volumes. I plan to apply causal mediation analysis to investigate whether the effect of sex hormones (IV, predictor) on spatial behavior (DV, outcome) is mediated by participants' T1 hippocampal and T2 subfield volume (mediator).

To account for missing data, I will use full information max likelihood implemented in the mediation analyses package `lavaan`. I will also use bootstrapped confidence intervals given non-normal/non-linear assumptions of the data.


# Data Analysis


## T1 mediation: women

```{r t1-data}
#Read in the data
data_t1 <- read_csv(here("data", "HAS_SNAG_mastersheet_tidy.csv"))

#Filter for midlife women, has dsp data, has t1 data
data_t1 <- data_t1 %>% 
  filter(age_group == "Midlife", 
         #t1_status == "Yes",
         dsp_useable == "Yes") %>% 
  dplyr::select(subject_id, sex,
         age_scan_years:testosterone_spatial_ng_dl,
         t1_vol_left_hipp_aal_2d_d1_r, t1_vol_right_hipp_aal_2d_d1_r,
         t1_vbm_tiv) %>% 
  mutate(repo_status_spatial = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post", "Men"))) %>% 
  #Further exclude these subjects:
  filter(!subject_id %in% c(
    #"309", #bad participant
    #"316", #vertigo/took Wellbutrin for mood and Lipitor for cholesterol 7 days/week of scan
     "329", #on prednisone 7 days/week of scan
    #"352", #current MDD/depression
     "372" #past neuroschistosomiasis at 24 years old
  ))

#Create average t1 hipp volume
#Create function for apply to variables
dividebyTIV <- function(x, na.rm = FALSE) (x/data_t1$t1_vbm_tiv)

#Apply function to variables
data_t1 <- data_t1 %>% 
  
  #Average left and right regions
  #No need to multiply since values are the same proportion
  mutate(avg_t1_hipp = (t1_vol_left_hipp_aal_2d_d1_r + 
                        t1_vol_right_hipp_aal_2d_d1_r)/2) %>% 
  
  #Correct using TIV from SPM VBM
  mutate_at(vars(avg_t1_hipp),dividebyTIV) %>% 

  #Multiply to get proportions
  mutate(avg_t1_hipp = avg_t1_hipp*1000)


#Women and men
data_t1_repo <- data_t1 %>% 
  filter(sex == "Female") %>% 
  mutate(repo_status = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post"))) 
data_t1_men <- data_t1 %>% 
  filter(sex == "Male") 
```

### EDA

```{r}
#Basic demo table
data_t1 %>% 
  group_by(sex) %>% 
  summarize(count = n(),
            mean_age = mean(age_spatial_years, na.rm=TRUE),
            sd_age = sd(age_spatial_years, na.rm=TRUE),
            min_age = min(age_spatial_years, na.rm=TRUE),
            max_age = max(age_spatial_years, na.rm=TRUE),
            mean_vol = mean(avg_t1_hipp, na.rm=TRUE),
            sd_vol = sd(avg_t1_hipp, na.rm=TRUE),
            mean_succ = mean(dsp_success_pct, na.rm=TRUE),
            sd_succ = sd(dsp_success_pct, na.rm=TRUE),
            mean_si = mean(dsp_si_true_pct, na.rm=TRUE),
            sd_si = sd(dsp_si_true_pct, na.rm=TRUE)) %>% 
  kable(
    col.names = c("Sex", "N", "Mean Age (years)", "Std. Dev. Age",
                      "Min. Age", "Max. Age", "Mean T1 hipp (volume)",
                      "Std. Dev. T1 hipp", "Mean Wayfinding Success (%)",
                      "Std. Dev Wayfinding Success", "Mean Solution Index (%)",
                      "Std. Dev. Solution Index (%)"),
        #Change alignment
        align = c(rep("c", 9)),
        #Round digits to 2
        digits = 2,
        #Change width of table
        table.attr = "style='width:80%;'") %>% 
  
  #Make table striped and hover
  kable_styling(bootstrap_options = c("hover", "striped"),
                #Center table
                position = "center")
```


### Using `mediation`

#### E

With regards to mediation, bootstrapping is often used where normality does not seem like a reasonable assumption. We can do so using `mediation` package.


1. Estradiol predicting Solution Index

Total effect

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ estradiol_spatial_pg_ml, data=data_t1_repo)
tidy(fit.totaleffect)
```


2. Estradiol predicting T1 hipp volume

Effect of IV on mediatior

```{r}
fit.mediator <- lm(avg_t1_hipp ~ estradiol_spatial_pg_ml, data=data_t1_repo)
tidy(fit.mediator)
```


3. Estradiol and CA1 predicting SOlution Index

Effect of mediator on DV

```{r}
fit.dv <- lm(dsp_si_true_pct ~ estradiol_spatial_pg_ml + avg_t1_hipp, data=data_t1_repo)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'estradiol_spatial_pg_ml', 
                   mediator = 'avg_t1_hipp', 
                   #SI = TRUE, # sequential ignorability assumption, only for missing data
                   boot = TRUE, sims = 1000)
summary(results)
```

There is a significant total effect and ADE, but not mediated effect.

#### P

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ progesterone_spatial_ng_ml, data=data_t1_repo)
tidy(fit.totaleffect)

fit.mediator <- lm(avg_t1_hipp ~ progesterone_spatial_ng_ml, data=data_t1_repo)
tidy(fit.mediator)

fit.dv <- lm(dsp_si_true_pct ~ progesterone_spatial_ng_ml + avg_t1_hipp, data=data_t1_repo)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'progesterone_spatial_ng_ml', 
                   mediator = 'avg_t1_hipp', 
                   #SI = TRUE, # sequential ignorability assumption
                   boot = TRUE, sims = 1000)
summary(results)
```

Neither mediated nor total effects observed.

#### FSH

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ fsh_spatial_miu_ml, data=data_t1_repo)
tidy(fit.totaleffect)

fit.mediator <- lm(avg_t1_hipp ~ fsh_spatial_miu_ml, data=data_t1_repo)
tidy(fit.mediator)

fit.dv <- lm(dsp_si_true_pct ~ fsh_spatial_miu_ml + avg_t1_hipp, data=data_t1_repo)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'fsh_spatial_miu_ml', 
                   mediator = 'avg_t1_hipp', 
                   #SI = TRUE, # sequential ignorability assumption
                   boot = TRUE, sims = 1000)
summary(results)
```

Marginal total effect and ADE, but no significant mediated effect.

### Using `lavaan`


#### E

```{r}
model <- ' # direct effect
             dsp_si_true_pct ~ c*estradiol_spatial_pg_ml
           # mediator
             avg_t1_hipp ~ a*estradiol_spatial_pg_ml
             dsp_si_true_pct ~ b*avg_t1_hipp
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
# fit <- sem(model, data = data,
#            std.ov = TRUE, #standardize variables
#            meanstructure = TRUE,
#            #se = 'robust.mlr', #incomplete data
#            missing = "fiml")
# summary(fit)

fit <- sem(model, data = data_t1_repo,
           std.ov = TRUE, #standardize variables
           meanstructure = TRUE,
           se = 'bootstrap',
           bootstrap = 5000,
           missing = "fiml")
summary(fit)
```


```{r}
#Print all model parameters
parameterestimates(fit, se=TRUE,
                   pvalue=TRUE, #corresponding to the z-statistic, evaluated under a standard normal distribution
                   fmi=TRUE, #fraction of missing info/parameter
                   boot.ci.type = "bca.simple", #adjusted bootstrap percentile (BCa) method, but with no correction for acceleration (only for bias)
                   standardized = TRUE) # %>% kable()
```


#### P

```{r}
model <- ' # direct effect
             dsp_si_true_pct ~ c*progesterone_spatial_ng_ml
           # mediator
             avg_t1_hipp ~ a*progesterone_spatial_ng_ml
             dsp_si_true_pct ~ b*avg_t1_hipp
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
# fit <- sem(model, data = data,
#            std.ov = TRUE, #standardize variables
#            meanstructure = TRUE,
#            #se = 'robust.mlr', #incomplete data
#            missing = "fiml")
# summary(fit)

fit <- sem(model, data = data_t1_repo,
           std.ov = TRUE, #standardize variables
           meanstructure = TRUE,
           se = 'bootstrap',
           bootstrap = 5000,
           missing = "fiml")
summary(fit)
```

#### FSH


```{r}
model <- ' # direct effect
             dsp_si_true_pct ~ c*fsh_spatial_miu_ml
           # mediator
             avg_t1_hipp ~ a*fsh_spatial_miu_ml
             dsp_si_true_pct ~ b*avg_t1_hipp
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
# fit <- sem(model, data = data,
#            std.ov = TRUE, #standardize variables
#            meanstructure = TRUE,
#            #se = 'robust.mlr', #incomplete data
#            missing = "fiml")
# summary(fit)

fit <- sem(model, data = data_t1_repo,
           std.ov = TRUE, #standardize variables
           meanstructure = TRUE,
           se = 'bootstrap',
           bootstrap = 5000,
           missing = "fiml")
summary(fit)
```


```{r}
#Print all model parameters
parameterestimates(fit, se=TRUE,
                   pvalue=TRUE, #corresponding to the z-statistic, evaluated under a standard normal distribution
                   fmi=TRUE, #fraction of missing info/parameter
                   boot.ci.type = "bca.simple", #adjusted bootstrap percentile (BCa) method, but with no correction for acceleration (only for bias)
                   standardized = TRUE) # %>% kable()
```
Lavaan packages shows that C and B pathways are significant.



## T2 mediation: women

```{r t2-data}
#Read in the data
##### EVENTUALLY UPDATE T2 HIPP RESULTS
data_t2 <- read_csv(here("data", "HAS_SNAG_mastersheet_tidy.csv"))

#Filter for midlife women, has dsp data, has t2hipp data
data_t2 <- data_t2 %>% 
  filter(age_group == "Midlife", 
         #t2hipp_useable == "Yes",
         dsp_useable == "Yes") %>% 
  dplyr::select(subject_id, sex, 
         age_scan_years:testosterone_spatial_ng_dl,
         t2hipp_vol_avg_ca1:t2hipp_vol_avg_sub,
         t2hipp_vol_left_ca1:t2hipp_vol_right_sub,
         t1_vbm_tiv) %>% 
  mutate(repo_status = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post", "Men"))) %>% 
  #Further exclude these subjects:
  filter(!subject_id %in% c(
    #"309", #bad participant
    #"316", #vertigo/took Wellbutrin for mood and Lipitor for cholesterol 7 days/week of scan
     "329", #on prednisone 7 days/week of scan
    #"352", #current MDD/depression
     "372" #past neuroschistosomiasis at 24 years old
  ))


########## Create T2 total hipp and MTL volumes
data_t2 <- data_t2 %>% 
  
  #Rename columns
  rename(avg_ca1 = t2hipp_vol_avg_ca1,
         avg_ca23 = t2hipp_vol_avg_ca23,
         avg_dg = t2hipp_vol_avg_dg,
         avg_erc = t2hipp_vol_avg_erc,
         avg_phc = t2hipp_vol_avg_phc,
         avg_prc = t2hipp_vol_avg_prc,
         avg_sub = t2hipp_vol_avg_sub) %>% 
  
  #Create T2 total hipp and MTL
  mutate(avg_total_hipp = avg_ca1 + avg_ca23 + avg_dg + avg_sub,
         avg_mtl = avg_ca1 + avg_ca23 + avg_dg + avg_sub +
           avg_erc + avg_phc + avg_prc)


#Women and men
data_t2_repo <- data_t2 %>% 
  filter(sex == "Female") %>% 
  mutate(repo_status = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post"))) 
data_t2_men <- data_t2 %>% 
  filter(sex == "Male") 


########## Correct using TIV, then average left and right

##### T2hipp


# #Create function for apply to variables
# #t2hipp_vol_tiv
# dividebyTIV <- function(x, na.rm = FALSE) (x/data$t1_vbm_tiv)
# 
# #Correct left and right volumes with TIV
# data <- data %>% 
#   
#   #Correct using TIV from SPM
#   #CA1, CA23, DG, ERC,PHC, PRC, SUB, GMV
#   mutate_at(vars(t2hipp_vol_left_ca1:t2hipp_vol_right_sub),
#             dividebyTIV) %>% 
#   
#   #Average left and right subfields
#   mutate(avg_ca1 = (t2hipp_vol_left_ca1+t2hipp_vol_right_ca1) / 2,
#          avg_ca23 = (t2hipp_vol_left_ca23+t2hipp_vol_right_ca23) / 2,
#          avg_dg = (t2hipp_vol_left_dg+t2hipp_vol_right_dg) / 2,
#          avg_erc = (t2hipp_vol_left_erc+t2hipp_vol_right_erc) / 2,
#          avg_phc = (t2hipp_vol_left_phc+t2hipp_vol_right_phc) / 2,
#          avg_prc = (t2hipp_vol_left_prc+t2hipp_vol_right_prc) / 2,
#          avg_sub = (t2hipp_vol_left_sub+t2hipp_vol_right_sub) / 2) %>% 
#   
#   #Calculate total left and right hipp
#   mutate(total_l_hipp = (t2hipp_vol_left_ca1 + 
#                          t2hipp_vol_left_ca23 +
#                          t2hipp_vol_left_dg + 
#                          t2hipp_vol_left_sub),
#          total_r_hipp = (t2hipp_vol_right_ca1 + 
#                          t2hipp_vol_right_ca23 + 
#                          t2hipp_vol_right_dg + 
#                          t2hipp_vol_right_sub),
#          avg_total_hipp = (total_l_hipp + total_r_hipp)/2) %>% 
#   
#   #Calculate left and right MTL
#   mutate(lmtl = (t2hipp_vol_left_ca1 + 
#                  t2hipp_vol_left_ca23 +
#                  t2hipp_vol_left_dg + 
#                  t2hipp_vol_left_sub + 
#                  t2hipp_vol_left_erc + 
#                  t2hipp_vol_left_phc + 
#                  t2hipp_vol_left_prc),
#          rmtl = (t2hipp_vol_right_ca1 + 
#                  t2hipp_vol_right_ca23 +
#                  t2hipp_vol_right_dg + 
#                  t2hipp_vol_right_sub + 
#                  t2hipp_vol_right_erc + 
#                  t2hipp_vol_right_phc + 
#                  t2hipp_vol_right_prc),
#          avg_mtl = (lmtl + rmtl)/2)
```


### Total Hipp

#### E

```{r}
model <- ' # direct effect
             dsp_si_true_pct ~ c*estradiol_spatial_pg_ml
           # mediator
             avg_total_hipp ~ a*estradiol_spatial_pg_ml
             dsp_si_true_pct ~ b*avg_total_hipp
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
# fit <- sem(model, data = data,
#            std.ov = TRUE, #standardize variables
#            meanstructure = TRUE,
#            #se = 'robust.mlr', #incomplete data
#            missing = "fiml")
# summary(fit)

fit <- sem(model, data = data_t2_repo,
           std.ov = TRUE, #standardize variables
           meanstructure = TRUE,
           se = 'bootstrap',
           bootstrap = 5000,
           missing = "fiml")
summary(fit)
```
Total effect observed.

#### P

#### FSH

### CA1

### CA23


### DG


### ERC

### PHC

### PRC


### SUB







# Summary





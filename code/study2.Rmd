---
title: 'Study 2: Causal Mediation Analysis'
author: "Shuying Yu"
date: "9/26/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center")

#Attach libraries
library(tidyverse)
library(here)
library(janitor)
library(ggpubr)
library(patchwork)
library(kableExtra)
library(foreign)
library(RColorBrewer)
library(plotly)
library(readr)
library(broom)
library(GGally)
library(psych)

#Medaition packages
library(lavaan)
library(mediation)
library(blavaan)
```


# Introduction

## Overview

**Total Effect (IV, Hormone to DV, Behavior):**

Study 1 (aka "Study 2, part 1") has shown that there is a correlation between sex hormones and spatial navigation strategy (`study1.Rmd`), such that higher estradiol is positively associated with higher use of shortcuts in the DSP task (higher solution index). Higher FSH, on the other hand, was marginally negatively associated with shortcut use (lower solution index) using Spearman rank correlations.

**Effect of IV (Hormone) on Mediator:**

Prior exploratory analysis for relationships between sex hormones and T2 subfield volume reveal certain significant relationships (`correlation_greymatter_hormones_corrected.Rmd`). Highlights of the results include estradiol negatively associated with CA1 for peris and with SUB for pres, and marginally negatively correlated with CA23 (all Spearman correlations). For progesterone, it was significantly positively correlated with CA1 for posts and with ERC for posts (both Pearson correlations). FSH was significantly negatively correlated with ERC and SUB for posts, negatively correlated with PHC for women overall, and marginally negatively associated with CA1 for posts (all Spearman correlations).

For other brain structures, total hippocampal volume was negatively correlated with estradiol for pres (Spearman) and MTL was marginally negatively correlated with FSH for posts (Spearman). 

For T1 hippocampal volume (`correlation_t1_hormones.Rmd`), there was a positive correlation with progesterone for posts (Spearman).

Significant effect of hormones, specifically estradiol and FSH, on the mediator (T2 subfields or T1 hippocampal volume) is an absolute prerequisite for mediation being possible.


**Other**


Following the correlations between hormones and brain structure, I explored the associations between brain structure and spatial navigation behaviors (`correlation_greymatter_behavior.Rmd` and `correlation_t1_hormones.Rmd`). Results revealed that position error was negatively correlated with PHC (Pearson), and solution index was marginally negatively associated with DG in men (Spearman). Total hippocampal volume from subfields revealed no significant associations.

For T1 hippocampal volume, DSP solution index was positively associated with GMV in women (Spearman), and marginally positively associated with GMV overall for women and men (Spearman).



# Research Question

Are there indirect effects, such that hippocampal grey matter volume mediates the relationship between sex hormones and spatial navigation behavior?

# Methods

Here, I determine how T1 hippocampal and T2 subfield volume mediate the relationship between sex hormones and behavior for navigation strategy. I will investigate whether there are any relationships between spatial navigation behaviors and T1 hippocampal and T2 subfield volumes. I plan to apply causal mediation analysis to investigate whether the effect of sex hormones (IV, predictor) on spatial behavior (DV, outcome) is mediated by participants' T1 hippocampal and T2 subfield volume (mediator).

To account for missing data, I will use full information max likelihood. 


# Data Analysis


## T1 mediation: women

```{r t1-data}
#Read in the data
data_t1 <- read_csv(here("data", "HAS_SNAG_mastersheet_tidy.csv"))

#Filter for midlife women, has dsp data, has t1 data
data_t1 <- data_t1 %>% 
  filter(age_group == "Midlife", 
         t1_status == "Yes",
         dsp_useable == "Yes") %>% 
  dplyr::select(subject_id, sex,
         age_scan_years:testosterone_spatial_ng_dl,
         t1_vol_left_hipp_aal_2d_d1_r, t1_vol_right_hipp_aal_2d_d1_r,
         t1_vbm_tiv) %>% 
  mutate(repo_status_spatial = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post", "Men"))) %>% 
  #Further exclude these subjects:
  filter(!subject_id %in% c(
    #"309", #bad participant
    #"316", #vertigo/took Wellbutrin for mood and Lipitor for cholesterol 7 days/week of scan
     "329", #on prednisone 7 days/week of scan
    #"352", #current MDD/depression
     "372" #past neuroschistosomiasis at 24 years old
  ))

#Create average t1 hipp volume
#Create function for apply to variables
dividebyTIV <- function(x, na.rm = FALSE) (x/data_t1$t1_vbm_tiv)

#Apply function to variables
data_t1 <- data_t1 %>% 
  
  #Correct using TIV from SPM VBM
  mutate_at(vars(t1_vol_left_hipp_aal_2d_d1_r, 
                 t1_vol_right_hipp_aal_2d_d1_r),
            dividebyTIV) %>%
  
  #Average left and right regions
  mutate(avg_t1_hipp = ((t1_vol_left_hipp_aal_2d_d1_r + 
                        t1_vol_right_hipp_aal_2d_d1_r)/2)*1000)


#Women and men
data_t1_women <- data_t1 %>% 
  filter(sex == "Female") %>% 
  mutate(repo_status_spatial = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post"))) 
data_t1_men <- data_t1 %>% 
  filter(sex == "Male") %>% 
  mutate(repo_status_spatial = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post"))) 
```

### EDA

```{r}
#Basic demo table
data_t1 %>% 
  group_by(sex) %>% 
  summarize(count = n(),
            mean_age = mean(age_spatial_years),
            sd_age = sd(age_spatial_years),
            min_age = min(age_spatial_years),
            max_age = max(age_spatial_years),
            mean_vol = mean(avg_t1_hipp),
            sd_vol = sd(avg_t1_hipp),
            mean_succ = mean(dsp_success_pct),
            sd_succ = sd(dsp_success_pct),
            mean_si = mean(dsp_si_true_pct),
            sd_si = sd(dsp_si_true_pct)) %>% 
  kable(
    col.names = c("Sex", "N", "Mean Age (years)", "Std. Dev. Age",
                      "Min. Age", "Max. Age", "Mean T1 hipp (volume)",
                      "Std. Dev. T1 hipp", "Mean Wayfinding Success (%)",
                      "Std. Dev Wayfinding Success", "Mean Solution Index (%)",
                      "Std. Dev. Solution Index (%)"),
        #Change alignment
        align = c(rep("c", 9)),
        #Round digits to 2
        digits = 2,
        #Change width of table
        table.attr = "style='width:80%;'") %>% 
  
  #Make table striped and hover
  kable_styling(bootstrap_options = c("hover", "striped"),
                #Center table
                position = "center")
```



```{r t1-distributions}
data_select <- data_t1_women %>% 
  dplyr::select(estradiol_spatial_pg_ml,
         avg_t1_hipp, dsp_si_true_pct)

ggpairs(data_select,  
        lower = list(continuous = "smooth")) + theme_bw()
```
Estradiol looks exponentially distributed, and SI is right-skewed


```{r}
describe(data_select)
```

### Using `mediation`

#### E

With regards to mediation, bootstrapping is often used where normality does not seem like a reasonable assumption. We can do so using `mediation` package.


1. Estradiol predicting Solution Index

Total effect

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ estradiol_spatial_pg_ml, data=data_t1_women)
tidy(fit.totaleffect)
```


2. Estradiol predicting T1 hipp volume

Effect of IV on mediatior

```{r}
fit.mediator <- lm(avg_t1_hipp ~ estradiol_spatial_pg_ml, data=data_t1_women)
tidy(fit.mediator)
```


3. Estradiol and CA1 predicting SOlution Index

Effect of mediator on DV

```{r}
fit.dv <- lm(dsp_si_true_pct ~ estradiol_spatial_pg_ml + avg_t1_hipp, data=data_t1_women)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'estradiol_spatial_pg_ml', 
                   mediator = 'avg_t1_hipp', 
                   #SI = TRUE, # sequential ignorability assumption, only for missing data
                   boot = TRUE, sims = 1000)
summary(results)
```


#### P

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ progesterone_spatial_ng_ml, data=data_t1_women)
tidy(fit.totaleffect)

fit.mediator <- lm(avg_t1_hipp ~ progesterone_spatial_ng_ml, data=data_t1_women)
tidy(fit.mediator)

fit.dv <- lm(dsp_si_true_pct ~ progesterone_spatial_ng_ml + avg_t1_hipp, data=data_t1_women)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'progesterone_spatial_ng_ml', 
                   mediator = 'avg_t1_hipp', 
                   #SI = TRUE, # sequential ignorability assumption
                   boot = TRUE, sims = 1000)
summary(results)
```


#### FSH

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ fsh_spatial_miu_ml, data=data_t1_women)
tidy(fit.totaleffect)

fit.mediator <- lm(avg_t1_hipp ~ fsh_spatial_miu_ml, data=data_t1_women)
tidy(fit.mediator)

fit.dv <- lm(dsp_si_true_pct ~ fsh_spatial_miu_ml + avg_t1_hipp, data=data_t1_women)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'fsh_spatial_miu_ml', 
                   mediator = 'avg_t1_hipp', 
                   #SI = TRUE, # sequential ignorability assumption
                   boot = TRUE, sims = 1000)
summary(results)
```


### Using `lavaan`


#### E

```{r}
model <- ' # direct effect
             dsp_si_true_pct ~ c*estradiol_spatial_pg_ml
           # mediator
             avg_t1_hipp ~ a*estradiol_spatial_pg_ml
             dsp_si_true_pct ~ b*avg_t1_hipp
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
# fit <- sem(model, data = data,
#            std.ov = TRUE, #standardize variables
#            meanstructure = TRUE,
#            #se = 'robust.mlr', #incomplete data
#            missing = "fiml")
# summary(fit)

fit <- sem(model, data = data_t1_women,
           std.ov = TRUE, #standardize variables
           meanstructure = TRUE,
           se = 'bootstrap',
           bootstrap = 1000,
           missing = "fiml")
summary(fit)
```

```{r}
#Boostrap test statistics

# bootstrap test statistic + compute p-value
T.boot <- bootstrapLavaan(fit, R=10, type="nonparametric",
                          FUN=fitMeasures, fit.measures="chisq")
pvalue.boot <- length(which(T.boot > T.orig))/length(T.boot)

```



#### Robust Mediation Analysis






## T2 mediation

```{r t2-data}
#Read in the data
##### EVENTUALLY UPDATE T2 HIPP RESULTS
data <- read_csv(here("data", "HAS_SNAG_mastersheet_tidy.csv"))

#Filter for midlife women, has dsp data, has t2hipp data
data <- data %>% 
  filter(age_group == "Midlife", 
         sex == "Female",
         t2hipp_status == "Yes",
         dsp_useable == "Yes") %>% 
  dplyr::select(subject_id, sex, 
         age_scan_years:testosterone_spatial_ng_dl,
         t2hipp_vol_left_ca1:t2hipp_vol_right_sub,
         t1_vbm_tiv) %>% 
  mutate(repo_status_spatial = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post")))

#Create function for apply to variables
#t2hipp_vol_tiv
dividebyTIV <- function(x, na.rm = FALSE) (x/data$t1_vbm_tiv)

#Correct left and right volumes with TIV
data <- data %>% 
  
  #Correct using TIV from SPM
  #CA1, CA23, DG, ERC,PHC, PRC, SUB, GMV
  mutate_at(vars(t2hipp_vol_left_ca1:t2hipp_vol_right_sub),
            dividebyTIV) %>% 
  
  #Average left and right subfields
  mutate(avg_ca1 = (t2hipp_vol_left_ca1+t2hipp_vol_right_ca1) / 2,
         avg_ca23 = (t2hipp_vol_left_ca23+t2hipp_vol_right_ca23) / 2,
         avg_dg = (t2hipp_vol_left_dg+t2hipp_vol_right_dg) / 2,
         avg_erc = (t2hipp_vol_left_erc+t2hipp_vol_right_erc) / 2,
         avg_phc = (t2hipp_vol_left_phc+t2hipp_vol_right_phc) / 2,
         avg_prc = (t2hipp_vol_left_prc+t2hipp_vol_right_prc) / 2,
         avg_sub = (t2hipp_vol_left_sub+t2hipp_vol_right_sub) / 2) %>% 
  
  #Calculate total left and right hipp
  mutate(total_l_hipp = (t2hipp_vol_left_ca1 + 
                         t2hipp_vol_left_ca23 +
                         t2hipp_vol_left_dg + 
                         t2hipp_vol_left_sub),
         total_r_hipp = (t2hipp_vol_right_ca1 + 
                         t2hipp_vol_right_ca23 + 
                         t2hipp_vol_right_dg + 
                         t2hipp_vol_right_sub),
         avg_total_hipp = (total_l_hipp + total_r_hipp)/2) %>% 
  
  #Calculate left and right MTL
  mutate(lmtl = (t2hipp_vol_left_ca1 + 
                 t2hipp_vol_left_ca23 +
                 t2hipp_vol_left_dg + 
                 t2hipp_vol_left_sub + 
                 t2hipp_vol_left_erc + 
                 t2hipp_vol_left_phc + 
                 t2hipp_vol_left_prc),
         rmtl = (t2hipp_vol_right_ca1 + 
                 t2hipp_vol_right_ca23 +
                 t2hipp_vol_right_dg + 
                 t2hipp_vol_right_sub + 
                 t2hipp_vol_right_erc + 
                 t2hipp_vol_right_phc + 
                 t2hipp_vol_right_prc),
         avg_mtl = (lmtl + rmtl)/2)
```


### EDA

```{r distributions}
data_select <- data %>% 
  dplyr::select(estradiol_scan_pg_ml,
         avg_ca1, dsp_si_true_pct)

ggpairs(data_select,  
        lower = list(continuous = "smooth")) + theme_bw()
```


Estradiol looks exponentially distributed, and SI is right-skewed


```{r descriptive-raw-vars}
#Descriptive stats
describe(data_select)
```


```{r boxcox}
##### Estradiol

#Check histogram and normality
hist(data$estradiol_scan_pg_ml)
shapiro.test(data$estradiol_scan_pg_ml) #yes

#Box-Cox transformation plot
bc <- MASS::boxcox(data$estradiol_scan_pg_ml ~ 1, 
                   plotit = TRUE)

#However, log transformation for estradiol doesn't fix normality
hist(log(data$estradiol_scan_pg_ml))
shapiro.test(log(data$estradiol_scan_pg_ml)) #yes
shapiro.test(sqrt(data$estradiol_scan_pg_ml)) #yes
shapiro.test(1/(data$estradiol_scan_pg_ml)) #yes

#Extract exact lambda from plot
lambda_e <- bc$x[which.max(bc$y)]
lambda_e #0.02020202

#New estradiol
data <- data %>% 
  mutate(new_estradiol = ((estradiol_scan_pg_ml^lambda_e) - 1) / lambda_e)

#Check transformed histogram
hist(data$new_estradiol)
shapiro.test(data$new_estradiol) #yes, p = 0.03883


##### CA1
#Check histogram
hist(data$avg_ca1)
shapiro.test(data$avg_ca1) #no


##### DSP Solution Index
hist(data$dsp_si_true_pct)
shapiro.test(data$dsp_si_true_pct) #yes
shapiro.test(log(data$dsp_si_true_pct)) #yes
shapiro.test(sqrt(data$dsp_si_true_pct)) #yes

#Make solution index positive
data_dsp <- data %>% 
  filter(dsp_useable == "Yes") %>% 
  mutate(dsp_si_pos = dsp_si_true_pct * 100)

#Box-Cox transformation plot
#Can't run with 0 in dataset, so use

hist(log(data$dsp_si_true_pct))
```

### Frequentist


#### Using `mediation`

With regards to mediation, bootstrapping is often used where normality does not seem like a reasonable assumption. We can do so using `mediation` package.


1. Estradiol predicting Solution Index

Total effect

```{r}
fit.totaleffect <- lm(dsp_si_true_pct ~ estradiol_scan_pg_ml, data=data)
tidy(fit.totaleffect)
```


2. Estradiol predicting CA1

Effect of IV on mediatior

```{r}
fit.mediator <- lm(avg_ca1 ~ estradiol_scan_pg_ml, data=data)
tidy(fit.mediator)
```


3. Estradiol and CA1 predicting SOlution Index

Effect of mediator on DV

```{r}
fit.dv <- lm(dsp_si_true_pct ~ estradiol_scan_pg_ml + avg_ca1, data=data)
tidy(fit.dv)
```


```{r}
results <- mediate(fit.mediator, 
                   fit.dv, 
                   treat = 'estradiol_scan_pg_ml', 
                   mediator = 'avg_ca23', 
                   SI = TRUE, # sequential ignorability assumption
                   boot = TRUE, sims = 100)
summary(results)
```



#### Using `lavaan`

```{r}
model <- ' # direct effect
             dsp_si_true_pct ~ c*estradiol_scan_pg_ml
           # mediator
             avg_ca1 ~ a*estradiol_scan_pg_ml
             dsp_si_true_pct ~ b*avg_ca1
           # indirect effect (a*b)
             ab := a*b
           # total effect
             total := c + (a*b)
         '
# fit <- sem(model, data = data,
#            std.ov = TRUE, #standardize variables
#            meanstructure = TRUE,
#            #se = 'robust.mlr', #incomplete data
#            missing = "fiml")
# summary(fit)

fit <- sem(model, data = data,
           std.ov = TRUE, #standardize variables
           meanstructure = TRUE,
           se = 'bootstrap',
           bootstrap = 100,
           missing = "fiml")
summary(fit)
```

```{r}
#Boostrap test statistics

# bootstrap test statistic + compute p-value
T.boot <- bootstrapLavaan(fit, R=10, type="nonparametric",
                          FUN=fitMeasures, fit.measures="chisq")
pvalue.boot <- length(which(T.boot > T.orig))/length(T.boot)

```



#### Robust Mediation Analysis




### Bayesian


```{r}

```



# Summary





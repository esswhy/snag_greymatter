---
title: 'Study 2: Causal Mediation Analysis'
author: "Shuying Yu"
date: "9/26/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center")

#Attach libraries
library(tidyverse)
library(here)
library(janitor)
library(ggpubr)
library(patchwork)
library(kableExtra)
library(foreign)
library(RColorBrewer)
library(plotly)
library(readr)
library(lavaan)
```


# Introduction

## Overview

**Total Effect (IV, Hormone to DV, Behavior):**

Study 1 (aka "Study 2, part 1") has shown that there is a correlation between sex hormones and spatial navigation strategy (`study1.Rmd`), such that higher estradiol is positively associated with higher use of shortcuts in the DSP task (higher solution index). Higher FSH, on the other hand, was marginally negatively associated with shortcut use (lower solution index) using Spearman rank correlations.

**Effect of IV (Hormone) on Mediator:**

Prior exploratory analysis for relationships between sex hormones and T2 subfield volume reveal certain significant relationships (`correlation_greymatter_hormones_corrected.Rmd`). Highlights of the results include estradiol negatively associated with CA1 for peris and with SUB for pres, and marginally negatively correlated with CA23 (all Spearman correlations). For progesterone, it was significantly positively correlated with CA1 for posts and with ERC for posts (both Pearson correlations). FSH was significantly negatively correlated with ERC and SUB for posts, negatively correlated with PHC for women overall, and marginally negatively associated with CA1 for posts (all Spearman correlations).

Significant effect of hormones, specifically estradiol and FSH, on the mediator (T2 subfields) is an absolute prerequisite for mediation being possible.

**Other**


Following the correlations between hormones and brain structure,I explored the associations between brain structure and spatial navigation behaviors (`correlation_greymatter_behavior.Rmd`). Results revealed that position error was negatively correlated with PHC (Pearson), and solution index was marginally negatively associated with DG in men (Spearman).


## Methods

Here, I determine how T2 subfield volume mediates the relationship between sex hormones and behavior for navigation strategy. I will investigate whether there are any relationships between spatial navigation behaviors and T2 subfield volumes. I plan to apply causal mediation analysis to investigate whether the effect of sex hormones (IV, predictor) on spatial behavior (DV, outcome) is mediated by participants' T2 subfield volume (mediator).

To account for missing data, I will use full information max likelihood. 


# Data Analysis

```{r data}
#Read in the data
##### EVENTUALLY UPDATE T2 HIPP RESULTS
data <- read_csv(here("data", "HAS_SNAG_mastersheet_tidy.csv"))

#Filter for midlife, has snag data, has t2hipp data
data <- data %>% 
  filter(age_group == "Midlife", 
         completed_spatial == "Yes",
         t2hipp_status == "Yes") %>% 
  select(subject_id, sex, age_scan_years:testosterone_spatial_ng_dl,
         t2hipp_vol_left_ca1:t2hipp_vol_csf) %>% 
  mutate(repo_status_spatial = fct_relevel(repo_status_spatial, 
                                    c("Pre", "Peri", "Post")))

#Create function for apply to variables
dividebyTIV <- function(x, na.rm = FALSE) (x/data$t2hipp_vol_tiv)

#Correct left and right volumes with TIV
data <- data %>% 
  mutate_at(vars(t2hipp_vol_left_ca1:t2hipp_vol_right_sub),
            dividebyTIV)

#Average left and right volumes
data <- data %>% 
  mutate(t2hipp_vol_ca1_cor = (t2hipp_vol_left_ca1+t2hipp_vol_right_ca1) / 2,
         t2hipp_vol_ca23_cor = (t2hipp_vol_left_ca23+t2hipp_vol_right_ca23) / 2,
         t2hipp_vol_dg_cor = (t2hipp_vol_left_dg+t2hipp_vol_right_dg) / 2,
         t2hipp_vol_erc_cor = (t2hipp_vol_left_erc+t2hipp_vol_right_erc) / 2,
         t2hipp_vol_phc_cor = (t2hipp_vol_left_phc+t2hipp_vol_right_phc) / 2,
         t2hipp_vol_prc_cor = (t2hipp_vol_left_prc+t2hipp_vol_right_prc) / 2,
         t2hipp_vol_sub_cor = (t2hipp_vol_left_sub+t2hipp_vol_right_sub) / 2
```




# Solution Index

## E2 and 

## FSH and 


## Misc


```{r, eval=FALSE}

## Total Effect (Hormones -> Behavior)

#Estradiol

#wayfinding success
fit.totaleffect <- lm(dsp_success_pct ~ estradiol_spatial_pg_ml,
                     data = data_women)
summary(fit.totaleffect)

#solution index
fit.totaleffect <- lm(dsp_si_true_pct ~ estradiol_spatial_pg_ml,
                     data = data_women)
summary(fit.totaleffect)



# There doesn’t necessarily have to be a significant relationship between the iv and the dv. Just as correlation doesn’t prove causation, no correlation does not disprove causation 
```







```{r, eval=FALSE}
## IV on Mediator

## Subregion Volume and Spatial Behavior


#Assessing any relationships between subregion volume and SNAG behavior, specifically with DSP. First, check normality of the volume data


#Subregions
par(mfrow=c(2,2))
hist(data_women$t2hipp_vol_ca1_cor)
hist(data_women$t2hipp_vol_ca23_cor)
hist(data_women$t2hipp_vol_mtl_cor)
hist(data_women$t2hipp_vol_totalhipp_cor)


#DSP 
par(mfrow=c(1,2))
hist(data_women$dsp_success_pct)
hist(data_women$dsp_si_true_pct)




#Subregion volumes appear to be normally distributed. There is an outlier wirh the MTL corrected subregion volume (max 20997.82 compared to mean of 7986.304).

#For DSP, wayfinding success if left skewed and solution index is right skewed. I try to see if I can take the log of these dependent variables to normalize them for Pearson correlation
```


```{r, eval=FALSE}
#log transform
par(mfrow=c(1,2))
hist(log(data_women$dsp_success_pct))
hist(log(data_women$dsp_si_true_pct))

#inverse
par(mfrow=c(1,2))
hist((data_women$dsp_success_pct)^-1)
hist((data_women$dsp_si_true_pct)^-1)

#square root
par(mfrow=c(1,2))
hist(sqrt(data_women$dsp_success_pct))
hist(sqrt(data_women$dsp_si_true_pct))


#Log transformation and square root makes the DSP dependent variable more normally distributed, moreso for solution index than for wayfinding success. Use spearman rank correlation instead.
```




```{r, eval=FALSE}
#Correlations: wayfinding success and CA1, CS23, MTL, totalhipp

########## Spearman for wayfinding success

#CA1
cor.test(data_women$t2hipp_vol_ca1_cor,
         data_women$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")

#CA23
cor.test(data_women$t2hipp_vol_ca23_cor,
         data_women$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")

#MTL
cor.test(data_women$t2hipp_vol_mtl_cor,
         data_women$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")

#Total hipp
cor.test(data_women$t2hipp_vol_totalhipp_cor,
         data_women$dsp_success_pct,
         conf.level = 0.95,
         method = "spearman")
```


```{r, eval=FALSE}
#Correlations: solution index and CA1, CS23, MTL, totalhipp

########## Spearman for solution index

#CA1
cor.test(data_women$t2hipp_vol_ca1_cor,
         data_women$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")

#CA23
cor.test(data_women$t2hipp_vol_ca23_cor,
         data_women$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")

#MTL
cor.test(data_women$t2hipp_vol_mtl_cor,
         data_women$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")

#Total hipp
cor.test(data_women$t2hipp_vol_totalhipp_cor,
         data_women$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
```







# Summary




